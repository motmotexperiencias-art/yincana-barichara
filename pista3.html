<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>Misi√≥n 4 | El Descanso</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body, html { margin: 0; padding: 0; background: #000; color: white; height: 100vh; width: 100vw; font-family: 'Courier New', monospace; overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* --- LAYOUT DIVIDIDO --- */
        #app-juego { position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: row; background: #000; }

        /* COLUMNA IZQUIERDA (CONTENIDO JUEGO) */
        .col-juego { 
            flex: 1; position: relative; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; background: #080808; 
            border-right: 2px solid #222; overflow-y: auto; padding: 20px;
        }

        /* COLUMNA DERECHA (MAPA DECORATIVO PC) */
        .col-mapa { flex: 1; position: relative; display: flex; }

        /* M√ìVIL (VERTICAL) */
        @media screen and (max-width: 768px) {
            #app-juego { flex-direction: column; }
            .col-mapa { display: none; } /* Ocultamos el mapa lateral en m√≥vil */
            .col-juego { border-right: none; width: 100%; }
        }

        /* --- UI ELEMENTOS --- */
        .progress-container { width: 100%; display: flex; justify-content: center; margin-bottom: 20px; }
        .progress-bar { display: flex; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; border: 1px solid #444; transition: 0.3s; }
        .dot.passed { background: #00cc66; border-color: #00cc66; box-shadow: 0 0 5px rgba(0,204,102,0.5); }
        .dot.active { background: #ff6600; border-color: #ff6600; transform: scale(1.3); box-shadow: 0 0 10px #ff6600; }
        .dot.future { background: transparent; }

        .etiqueta-evidencia {
            background: #ff6600; color: #000; font-weight: 900; padding: 6px 15px; 
            display: inline-block; text-transform: uppercase; letter-spacing: 2px; 
            font-size: 11px; border-radius: 5px; margin-bottom: 15px; box-shadow: 0 0 15px rgba(255,102,0,0.3);
        }

        .caja-contenedor {
            width: 100%; max-width: 400px; border: 1px solid #333; background: #111; 
            border-radius: 15px; overflow: hidden; padding: 20px; text-align: center; margin-bottom: 20px;
        }

        /* MAPA GPS (Dentro del juego) */
        #mapa-gps-activo { width: 100%; height: 250px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #ff6600; }
        #distancia-gps { font-size: 40px; color: #ff6600; font-weight: bold; margin: 10px 0; }
        .leaflet-tile { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }

        /* VIDEOS */
        .video-evidencia { width: 100%; border-radius: 10px; display: none; aspect-ratio: 9/16; object-fit: cover; }
        .video-evidencia.activo { display: block; }

        /* BOTONES */
        .btn-motmot { 
            background: transparent; border: 2px solid #ff6600; color: #ff6600; 
            padding: 12px 30px; border-radius: 50px; cursor: pointer; text-transform: uppercase; 
            letter-spacing: 2px; font-size: 11px; font-weight: bold; transition: 0.3s; width: 100%; margin-top:10px;
        }
        .btn-motmot:active { background: #ff6600; color: #000; }

        .btn-opcion-azul { 
            background: #1a1a1a; border: 1px solid #444; color: white; padding: 12px; 
            font-size: 13px; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 8px; 
            transition: 0.3s; text-align: left;
        }
        .btn-opcion-azul:active { border-color: #0055ff; background: #001133; }

        /* SCANNER */
        #scan-container { position: relative; width: 100%; height: 250px; background: black; overflow: hidden; border-radius: 10px; border: 2px solid #333; }
        #reader { width: 100%; height: 100%; }
        .laser { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #ff6600; box-shadow: 0 0 10px #ff6600; animation: scan 2s infinite; z-index: 10; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        /* AVISOS */
        #aviso-pausa { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #flash-efecto { display: none; position: fixed; inset: 0; background: white; z-index: 10000; pointer-events: none; }
        #mapa-referencia { width: 100%; height: 100%; filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
    </style>
</head>
<body>

    <div id="aviso-pausa">
        <h2 style="color:#ff6600; margin-bottom:10px;">SISTEMA EN PAUSA</h2>
        <p style="color:#ccc; font-size:12px; margin-bottom:20px;">Toca para reanudar la misi√≥n.</p>
        <button class="btn-motmot" style="width:auto" onclick="reanudarJuego()">CONTINUAR</button>
    </div>

    <div id="flash-efecto"></div>
    <audio id="musica-ambiente" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/terror-ambience-7003.mp3" loop></audio>
    <audio id="snd-exito" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/mixkit-church-bell-calling-603.wav"></audio>

    <div id="app-juego">
        
        <div class="col-juego">
            
            <div class="progress-container"><div class="progress-bar">
                <div class="dot passed"></div> <div class="dot passed"></div> <div class="dot passed"></div> <div class="dot active"></div> <div class="dot future"></div> 
            </div></div>

            <div id="step-intro" class="caja-contenedor" style="border:none; background:transparent;">
                <div style="font-size: 50px; margin-bottom:20px;">ü™¶</div>
                <div class="etiqueta-evidencia" id="lbl-titulo">PISTA 4: EL DESCANSO</div>
                <p style="color:#ccc; font-size:12px; margin-bottom:20px;" id="txt-intro">"Donde el silencio habla m√°s fuerte que las palabras. Dir√≠gete al lugar del descanso eterno."</p>
                <button class="btn-motmot" id="btn-start" onclick="iniciarGPS()">INICIAR RASTREO</button>
            </div>

            <div id="step-gps" class="caja-contenedor" style="display:none;">
                <div class="etiqueta-evidencia" id="lbl-obj">OBJETIVO: CEMENTERIO</div>
                <div id="mapa-gps-activo"></div>
                <div id="distancia-gps">---</div>
                <p style="font-size:10px; color:#ff6600;" id="lbl-status">BUSCANDO SE√ëAL...</p>
                <button class="btn-motmot" style="border-color:#444; color:#666; margin-top:20px;" onclick="llegamos()">OMITIR (DEBUG)</button>
            </div>

            <div id="step-videos" class="caja-contenedor" style="display:none;">
                <div class="etiqueta-evidencia">EVIDENCIA VISUAL</div>
                <video id="vid1" class="video-evidencia" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/PISTA4-5.mp4" playsinline muted loop></video>
                <video id="vid2" class="video-evidencia" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/PISTA4-2.mp4" playsinline muted loop></video>
                <video id="vid3" class="video-evidencia" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/PISTA4-1.mp4" playsinline muted loop></video>
                <video id="vid4" class="video-evidencia" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/PISTA4-4.mp4" playsinline muted loop></video>
                <video id="vid5" class="video-evidencia" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/PISTA4-6_compressed.mp4" playsinline muted loop></video>
                
                <button id="btn-next-vid" class="btn-motmot" onclick="siguienteVideo()">SIGUIENTE PRUEBA >></button>
            </div>

            <div id="step-scanner" class="caja-contenedor" style="display:none;">
                <div class="etiqueta-evidencia" id="lbl-scan">BUSCAR C√ìDIGO</div>
                <p style="font-size:11px; color:#ccc; margin-bottom:10px;" id="txt-scan">Busca el c√≥digo QR en la entrada o alrededores.</p>
                <div id="scan-container">
                    <div id="reader"></div>
                    <div class="laser"></div>
                </div>
                <button class="btn-motmot" onclick="activarCamara()" id="btn-cam">ACTIVAR C√ÅMARA</button>
                <p style="margin-top:10px; font-size:10px; text-decoration:underline; cursor:pointer;" onclick="irAQuiz()">Saltar (Error C√°mara)</p>
            </div>

            <div id="step-quiz-1" class="caja-contenedor" style="display:none;">
                <div class="etiqueta-evidencia">PRUEBA 1/3</div>
                <p id="q1">Analiza la fachada frontal de piedra.<br><br><strong>¬øCu√°ntas ventanas tiene?</strong></p>
                <button class="btn-opcion-azul" onclick="checkQ1(7)">7 VENTANAS</button>
                <button class="btn-opcion-azul" onclick="checkQ1(6)">6 VENTANAS</button>
                <button class="btn-opcion-azul" onclick="checkQ1(8)">8 VENTANAS</button>
            </div>

            <div id="step-quiz-2" class="caja-contenedor" style="display:none;">
                <div class="etiqueta-evidencia">PRUEBA 2/3</div>
                <p id="q2">Muro exterior derecho...<br><br><strong>¬øQu√© figura destaca?</strong></p>
                <button class="btn-opcion-azul" onclick="checkQ2(true)">üëº Un √Ångel</button>
                <button class="btn-opcion-azul" onclick="checkQ2(false)">üî® Un Martillo</button>
                <button class="btn-opcion-azul" onclick="checkQ2(false)">‚≠ê Una Estrella</button>
            </div>

            <div id="step-quiz-3" class="caja-contenedor" style="display:none;">
                <div class="etiqueta-evidencia">PRUEBA FINAL</div>
                <p id="q3">Sobre el arco de la puerta principal...<br><br><strong>¬øQu√© s√≠mbolo hay?</strong></p>
                <button class="btn-opcion-azul" onclick="validarFinal(true, this)">‚úùÔ∏è La Cruz de Piedra</button>
                <button class="btn-opcion-azul" onclick="validarFinal(false, this)">üïäÔ∏è Una Paloma</button>
            </div>

        </div>

        <div class="col-mapa">
            <div id="mapa-referencia"></div>
        </div>

    </div>

<script>
    // --- CONFIGURACI√ìN ---
    const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyH058Ipqtju9KZcLGgzM8TFnjOCSaBGIbEHC-kmzjsft2yV77GbagpuiKecE_i1pkX/exec";
    const DESTINO = { lat: 6.637370, lon: -73.227285 }; // Cementerio Barichara

    // --- IDIOMAS ---
    let idioma = localStorage.getItem('motmot_lang') || 'es';
    const TEXTOS = {
        es: {
            titulo: "PISTA 4: EL DESCANSO",
            intro: "\"Donde el silencio habla m√°s fuerte que las palabras. Dir√≠gete al lugar del descanso eterno.\"",
            btn_start: "INICIAR RASTREO",
            obj: "OBJETIVO: CEMENTERIO",
            status: "BUSCANDO SE√ëAL...",
            scan_title: "BUSCAR C√ìDIGO",
            scan_txt: "Busca el c√≥digo QR en la entrada o alrededores.",
            btn_cam: "ACTIVAR C√ÅMARA",
            q1: "Analiza la fachada frontal de piedra.<br><br><strong>¬øCu√°ntas ventanas tiene?</strong>",
            q2: "Muro exterior derecho...<br><br><strong>¬øQu√© figura destaca?</strong>",
            q3: "Sobre el arco de la puerta principal...<br><br><strong>¬øQu√© s√≠mbolo hay?</strong>"
        },
        en: {
            titulo: "CLUE 4: THE REST",
            intro: "\"Where silence speaks louder than words. Head to the place of eternal rest.\"",
            btn_start: "START TRACKING",
            obj: "TARGET: CEMETERY",
            status: "SEARCHING SIGNAL...",
            scan_title: "SCAN CODE",
            scan_txt: "Find the QR code at the entrance or surroundings.",
            btn_cam: "ACTIVATE CAMERA",
            q1: "Analyze the front stone facade.<br><br><strong>How many windows are there?</strong>",
            q2: "Right exterior wall...<br><br><strong>Which figure stands out?</strong>",
            q3: "Above the main door arch...<br><br><strong>What symbol is there?</strong>"
        }
    };

    let mapGPS, mapRef, watchID, html5QrCode;
    let videoIndex = 1;
    let musica = document.getElementById('musica-ambiente');

    // --- CARGA ---
    window.onload = () => {
        aplicarIdioma();
        initMapRef(); // Mapa derecho (PC)
        
        // Guardi√°n
        verificarPantalla();
        window.addEventListener("resize", verificarPantalla);
        document.addEventListener("visibilitychange", () => {
             if (document.hidden) document.getElementById('aviso-pausa').style.display = 'flex';
        });
    };

    function verificarPantalla() {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isFullScreen = document.fullscreenElement || document.webkitFullscreenElement;
        // Solo pausar si es m√≥vil, no es fullscreen y ya pasamos la intro
        if (isMobile && !isFullScreen && document.getElementById('step-intro').style.display === 'none') {
             document.getElementById('aviso-pausa').style.display = 'flex';
        }
    }

    function reanudarJuego() {
        let el = document.documentElement;
        if(el.requestFullscreen) el.requestFullscreen().catch(e=>{});
        else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen().catch(e=>{});
        document.getElementById('aviso-pausa').style.display = 'none';
        if(document.getElementById('step-intro').style.display === 'none') musica.play();
    }

    function aplicarIdioma() {
        const t = TEXTOS[idioma];
        document.getElementById('lbl-titulo').innerText = t.titulo;
        document.getElementById('txt-intro').innerText = t.intro;
        document.getElementById('btn-start').innerText = t.btn_start;
        document.getElementById('lbl-obj').innerText = t.obj;
        document.getElementById('lbl-status').innerText = t.status;
        document.getElementById('lbl-scan').innerText = t.scan_title;
        document.getElementById('txt-scan').innerText = t.scan_txt;
        document.getElementById('btn-cam').innerText = t.btn_cam;
        document.getElementById('q1').innerHTML = t.q1;
        document.getElementById('q2').innerHTML = t.q2;
        document.getElementById('q3').innerHTML = t.q3;
    }

    // --- MAPAS ---
    function initMapRef() {
        // Mapa est√°tico columna derecha
        mapRef = L.map('mapa-referencia', { zoomControl: false, attributionControl: false }).setView([DESTINO.lat, DESTINO.lon], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapRef);
        L.marker([DESTINO.lat, DESTINO.lon]).addTo(mapRef);
    }

    function initMapGPS() {
        // Mapa activo columna izquierda
        mapGPS = L.map('mapa-gps-activo', { zoomControl: false, attributionControl: false }).setView([DESTINO.lat, DESTINO.lon], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapGPS);
        const icon = L.divIcon({ html: '<div style="background:#ff6600; width:15px; height:15px; border-radius:50%; border:2px solid white;"></div>', className: '' });
        L.marker([DESTINO.lat, DESTINO.lon], {icon: icon}).addTo(mapGPS);
    }

    // --- FLUJO ---
    function iniciarGPS() {
        reanudarJuego();
        document.getElementById('step-intro').style.display = 'none';
        document.getElementById('step-gps').style.display = 'block';
        initMapGPS();
        musica.play();

        if (navigator.geolocation) {
            watchID = navigator.geolocation.watchPosition(pos => {
                const d = calcularDistancia(pos.coords.latitude, pos.coords.longitude, DESTINO.lat, DESTINO.lon);
                document.getElementById('distancia-gps').innerText = Math.round(d) + "m";
                if(d < 30) llegamos();
            }, null, { enableHighAccuracy: true });
        }
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function llegamos() {
        if(watchID) navigator.geolocation.clearWatch(watchID);
        document.getElementById('step-gps').style.display = 'none';
        document.getElementById('step-videos').style.display = 'block';
        document.getElementById('vid1').classList.add('activo');
        document.getElementById('vid1').play();
    }

    function siguienteVideo() {
        if(videoIndex < 5) {
            let actual = document.getElementById('vid'+videoIndex);
            actual.pause();
            actual.classList.remove('activo');
            videoIndex++;
            let next = document.getElementById('vid'+videoIndex);
            next.classList.add('activo');
            next.play();
        } else {
            // Fin videos -> Scanner
            document.getElementById('step-videos').style.display = 'none';
            document.getElementById('step-scanner').style.display = 'block';
        }
    }

    // --- ESC√ÅNER ---
    function activarCamara() {
        document.getElementById('btn-cam').style.display = 'none';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, 
            (text) => {
                if(text.toUpperCase().includes("PISTA_04") || text.toUpperCase().includes("BARICHARA")) {
                    html5QrCode.stop().then(irAQuiz);
                }
            }
        ).catch(() => { alert("Error c√°mara"); document.getElementById('btn-cam').style.display='block'; });
    }

    function irAQuiz() {
        if(html5QrCode && html5QrCode.isScanning) html5QrCode.stop();
        document.getElementById('step-scanner').style.display = 'none';
        document.getElementById('step-quiz-1').style.display = 'block';
    }

    // --- QUIZ ---
    function checkQ1(n) {
        if(n === 7) {
            document.getElementById('step-quiz-1').style.display = 'none';
            document.getElementById('step-quiz-2').style.display = 'block';
        } else alert("Error. Cuenta bien.");
    }
    function checkQ2(ok) {
        if(ok) {
            document.getElementById('step-quiz-2').style.display = 'none';
            document.getElementById('step-quiz-3').style.display = 'block';
        } else alert("Incorrecto. Mira el muro derecho.");
    }

    function validarFinal(ok, el) {
        if(ok) {
            el.style.background = "#27ae60";
            document.getElementById('flash-efecto').style.display = "block";
            document.getElementById('snd-exito').play();
            musica.pause();
            localStorage.setItem('motmot_pista', 5);
            
            const usuario = localStorage.getItem('motmot_clave');
            if(usuario) {
                const url = `${URL_GOOGLE}?action=guardar_progreso&codigo=${usuario}&pista=5`;
                ejecutarJSONP(url, () => setTimeout(() => window.location.href = "index.html", 3000));
            } else {
                setTimeout(() => window.location.href = "index.html", 3000);
            }
        } else {
            el.style.background = "#c0392b";
            setTimeout(() => el.style.background = "#1a1a1a", 1000);
        }
    }

    function ejecutarJSONP(url, callback) {
        const cbName = 'jsonp_' + Math.round(100000 * Math.random());
        window[cbName] = (data) => { delete window[cbName]; document.body.removeChild(script); callback(data); };
        const script = document.createElement('script');
        script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + cbName;
        document.body.appendChild(script);
    }
</script>
</body>
</html>
