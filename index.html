<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Búsqueda del Tesoro | Barichara</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        /* ESTILOS IGUALES A TU DISEÑO ORIGINAL */
        :root { --naranja: #ff6600; --verde: #00cc66; --negro: #000; }
        body, html { margin: 0; padding: 0; background: var(--negro); color: white; height: 100vh; font-family: 'Verdana', sans-serif; overflow: hidden; }
        .capa { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: #000; z-index: 10; text-align: center; }
        .activa { display: flex !important; }
        
        .btn-mot { 
            background: transparent; border: 2px solid var(--naranja); color: var(--naranja); 
            padding: 15px 40px; border-radius: 50px; font-weight: bold; cursor: pointer; 
            text-transform: uppercase; margin-top: 20px; letter-spacing: 2px;
        }
        .btn-mot:active { background: var(--naranja); color: #000; }
        
        input { background: transparent; border: none; border-bottom: 2px solid #666; color: white; padding: 10px; margin: 10px; text-align: center; font-size: 18px; outline: none; }
        
        /* Ajustes para el video de fondo */
        .video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.4; z-index: -1; }
    </style>
</head>
<body>

    <div id="capa-login" class="capa activa">
        <video class="video-bg" autoplay loop muted playsinline src="https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-14.mp4"></video>
        <h2 style="color:var(--naranja); letter-spacing:3px;">BARICHARA</h2>
        <p style="font-size:10px; letter-spacing:2px; margin-bottom:20px;">ACCESO AL SISTEMA</p>
        
        <input type="text" id="reg-nombre" placeholder="Nombre Agente">
        <input type="text" id="reg-clave" placeholder="Clave Misión">
        <button class="btn-mot" onclick="login()">INICIAR</button>
        <p id="msg-login" style="margin-top:15px; font-size:11px; color:#aaa;"></p>
    </div>

    <div id="capa-tablero" class="capa">
        <p style="color:var(--verde); letter-spacing:2px;">ESTADO DE MISIÓN</p>
        <h1 id="txt-nivel" style="font-size:40px; margin:10px 0;">CARGANDO...</h1>
        <p id="txt-desc" style="max-width:80%; color:#ccc; font-size:12px;">Esperando instrucciones del satélite...</p>
        <button id="btn-accion" class="btn-mot" onclick="">...</button>
    </div>

<script>
    // --- CONFIGURACIÓN ---
    // PEGA AQUÍ LA URL QUE TE DIÓ GOOGLE APPS SCRIPT AL PUBLICAR:
    const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyH058Ipqtju9KZcLGgzM8TFnjOCSaBGIbEHC-kmzjsft2yV77GbagpuiKecE_i1pkX/exec"; 

    // AQUÍ CONECTAMOS LOS ARCHIVOS (El Enrutador)
    const RUTAS_ARCHIVOS = {
        1: "pista1.html",
        2: "pista2.html",
        3: "pista3.html",
        4: "pista4.html",
        5: "pista5.html"
    };

    // --- LÓGICA DE LOGIN ---
    function login() {
        const nombre = document.getElementById('reg-nombre').value;
        const clave = document.getElementById('reg-clave').value.toUpperCase();
        if(!nombre || !clave) return alert("Faltan datos");

        document.getElementById('msg-login').innerText = "CONECTANDO...";
        
        // Guardamos localmente para no preguntar siempre
        localStorage.setItem('motmot_agente', nombre);
        localStorage.setItem('motmot_clave', clave);

        // Llamada a Google Sheets
        fetch(`${URL_GOOGLE}?action=registrar_inicio&codigo=${clave}&nombre=${encodeURIComponent(nombre)}`)
        .then(r => r.text()) // Leemos como texto porque JSONP a veces es tricky, pero fetch directo funciona si el GAS retorna JSON
        .then(txt => {
            // Nota: Tu GAS devuelve JSONP (callback(...)). Vamos a limpiar eso para leer el JSON.
            const jsonLimpio = txt.replace(/^.*?\(|\)$/g, ''); 
            const data = JSON.parse(jsonLimpio);

            if(data.status === "success") {
                localStorage.setItem('motmot_pista', data.pista_actual || 1);
                mostrarTablero();
            } else {
                document.getElementById('msg-login').innerText = "ERROR: " + (data.code || "Clave inválida");
            }
        })
        .catch(e => {
            // Fallback si falla Google: Dejar pasar si hay datos locales
            console.log("Offline mode o error: " + e);
            mostrarTablero();
        });
    }

    // --- LÓGICA DEL TABLERO ---
    function mostrarTablero() {
        document.getElementById('capa-login').classList.remove('activa');
        document.getElementById('capa-tablero').classList.add('activa');

        const nivel = parseInt(localStorage.getItem('motmot_pista') || 1);
        document.getElementById('txt-nivel').innerText = "PISTA " + nivel;

        const btn = document.getElementById('btn-accion');
        const desc = document.getElementById('txt-desc');

        // VERIFICAMOS SI HAY ARCHIVO HTML PARA ESTE NIVEL
        if (RUTAS_ARCHIVOS[nivel]) {
            desc.innerText = "Esta pista requiere inmersión visual. Accede al módulo.";
            btn.innerText = "ABRIR PISTA " + nivel;
            btn.onclick = () => {
                window.location.href = RUTAS_ARCHIVOS[nivel];
            };
        } else {
            // Si es nivel 6 o más (o el tesoro), usamos lógica genérica (o escáner aquí)
            desc.innerText = "Busca el código físico en la zona.";
            btn.innerText = "ESCANEAR CÓDIGO";
            btn.onclick = () => alert("Aquí abriría el escáner genérico (Pendiente config)");
        }
    }

    // Auto-login si ya entró antes
    window.onload = () => {
        if(localStorage.getItem('motmot_clave')) login();
    };
</script>
</body>
</html>
