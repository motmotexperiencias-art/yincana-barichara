<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <title>B√∫squeda del Tesoro | Barichara</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --naranja: #ff6600; --verde: #00cc66; --negro: #000; --gris: #111; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { margin: 0; padding: 0; background: var(--negro); color: white; height: 100dvh; width: 100vw; font-family: 'Verdana', sans-serif; overflow: hidden; }
        
        /* BOTONES FLOTANTES */
        #btn-toggle-fs {
            position: fixed; top: 15px; left: 15px; z-index: 999999;
            background: rgba(0,0,0,0.3); border: 1px solid #555;
            color: #888; padding: 6px 10px; border-radius: 20px;
            font-size: 10px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
        }

        /* CAPAS PRINCIPALES */
        .capa { position: absolute; top: 0; left: 0; width: 100%; height: 100dvh; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; z-index: 10; background: var(--negro); }
        .activa { display: flex !important; }
        .video-bg { position: absolute; z-index: -1; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.4; filter: brightness(0.7); }
        
        /* CAPA DE ROTACI√ìN */
        #capa-rotar { position: fixed; inset: 0; background: #000; z-index: 100000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        #icono-rotar { font-size: 60px; animation: girar 2s infinite; margin-bottom: 20px; }
        @keyframes girar { 0% { transform: rotate(0deg); } 50% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
        @media (orientation: portrait) { #capa-rotar { display: flex !important; } }

        /* CAPA DE PAUSA (Click to play) */
        #capa-fullscreen-request {
            position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 99990;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; backdrop-filter: blur(8px);
        }

        /* ESTILOS DE FORMULARIO MINIMALISTA */
        input { 
            background: transparent; 
            border: none; 
            border-bottom: 2px solid #666; 
            color: white; 
            padding: 12px; 
            margin: 15px 0; 
            width: 100%; 
            max-width: 260px; /* No tan ancho */
            text-align: center; 
            font-size: 16px; 
            outline: none; 
            transition: 0.3s; 
            border-radius: 0; /* Evitar bordes redondos en iOS */
        }
        input:focus { border-bottom-color: var(--naranja); transform: scale(1.05); }
        input::placeholder { color: #888; letter-spacing: 1px; font-size: 12px; }

        .btn-mot { 
            background: transparent; 
            border: 2px solid var(--naranja); 
            color: var(--naranja); 
            padding: 14px 30px; 
            border-radius: 50px; /* M√°s moderno */
            font-weight: bold; 
            cursor: pointer; 
            text-transform: uppercase; 
            width: auto; 
            min-width: 200px;
            font-size: 13px; 
            margin-top: 20px; 
            transition: 0.3s; 
            letter-spacing: 2px;
        }
        .btn-mot:active { background: var(--naranja); color: #000; transform: scale(0.95); }

        /* BANDERAS */
        .flag-btn {
            font-size: 45px; /* Banderas grandes */
            background: none; border: none; cursor: pointer;
            margin: 0 15px; transition: transform 0.2s;
        }
        .flag-btn:active { transform: scale(1.2); }

        /* MODAL DE ALERTA PERSONALIZADA (Reemplaza alert) */
        #capa-alerta {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-caja {
            background: #111; border: 2px solid var(--naranja); border-radius: 15px;
            padding: 30px; max-width: 85%; width: 320px; text-align: center;
            box-shadow: 0 0 30px rgba(255, 102, 0, 0.2);
        }
        .modal-titulo { color: var(--naranja); font-size: 18px; font-weight: bold; margin-bottom: 15px; letter-spacing: 2px;}
        .modal-texto { color: #ddd; font-size: 14px; margin-bottom: 25px; line-height: 1.5; }

        /* Timeline y Ranking */
        #tabla-ranking { width: 100%; max-width: 400px; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        #tabla-ranking th { color: var(--naranja); border-bottom: 1px solid #333; padding: 10px; }
        #tabla-ranking td { padding: 10px; border-bottom: 1px solid #222; }
        .timeline { display: flex; flex-direction: column; gap: 15px; overflow-y: auto; width: 100%; padding: 100px 0; align-items: center; }
        .hito { display: flex; align-items: center; gap: 15px; width: 85%; max-width: 380px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; opacity: 0.3; pointer-events: none; border: 1px solid transparent; }
        .hito.actual { opacity: 1; pointer-events: auto; border-color: var(--naranja); background: rgba(255,102,0,0.1); }
        .hito.completado { opacity: 0.6; pointer-events: auto; border-left: 4px solid var(--verde); }
        .bola { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #444; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; font-size: 14px; background: #000; }
        
        #scan-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #reader { width: 80vw; height: 80vw; max-width: 350px; border: 2px solid var(--naranja); border-radius: 15px; overflow: hidden; }
        #flash-effect { position: fixed; inset: 0; background: white; z-index: 20000; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        
        /* T√≠tulos */
        h2 { font-size: 20px; margin: 0; }
        h3 { font-size: 18px; margin: 0; }
    </style>
</head>
<body>

    <div id="flash-effect"></div>

    <div id="capa-alerta">
        <div class="modal-caja">
            <div id="alerta-titulo" class="modal-titulo">AVISO</div>
            <div id="alerta-texto" class="modal-texto">Mensaje del sistema...</div>
            <button class="btn-mot" onclick="cerrarAlerta()" style="padding: 10px 20px; margin-top: 0; font-size: 12px; border-color: #555; color: #fff;">ENTENDIDO</button>
        </div>
    </div>

    <div id="btn-toggle-fs" onclick="toggleFullScreen()">‚õ∂ PANTALLA</div>

    <div id="capa-rotar">
        <div id="icono-rotar">üì±</div>
        <h3>GIRA TU DISPOSITIVO</h3>
        <p style="opacity: 0.7; font-size: 13px; margin-top: 10px;">Experiencia dise√±ada en horizontal</p>
    </div>

    <div id="capa-fullscreen-request">
        <h2 style="color:var(--naranja); letter-spacing: 5px; margin-bottom: 20px;">PAUSA</h2>
        <p style="margin-bottom: 30px; font-size: 13px; opacity: 0.8;">Toca para continuar la aventura en pantalla completa.</p>
        <button class="btn-mot" onclick="activarModoInmersivo()">CONTINUAR JUEGO</button>
    </div>

    <div id="capa-login" class="capa activa">
        <video class="video-bg" autoplay muted loop playsinline src="https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-14.mp4"></video>
        
        <div style="margin-bottom: 40px;">
            <p style="font-size: 10px; opacity: 0.6; letter-spacing: 3px; margin-bottom: 5px;">BARICHARA</p>
            <h2 style="letter-spacing:3px; color: var(--naranja);">B√öSQUEDA DEL TESORO</h2>
            <p style="font-size: 10px; opacity: 0.6; letter-spacing: 3px; margin-top: 5px;">MOT MOT EXPERIENCIAS</p>
        </div>
        
        <div id="paso-idioma">
            <button class="flag-btn" onclick="setLanguage('es')">üá®üá¥</button>
            <button class="flag-btn" onclick="setLanguage('en')">üá¨üáß</button>
        </div>

        <div id="paso-form" style="display:none; width:100%; flex-direction:column; align-items:center;">
            <input type="text" id="reg-nombre" placeholder="Nombre Agente" autocomplete="off">
            <input type="text" id="reg-clave" placeholder="C√≥digo de Acceso" autocomplete="off">
            
            <button id="btn-entrar" class="btn-mot" style="border-color:var(--verde); color:var(--verde);" onclick="iniciarMision()"></button>
            
            <button class="btn-mot" onclick="verRanking('general')" style="font-size: 10px; border-color: #333; color: #777; padding: 10px 20px; min-width: auto;">üèÜ RANKING GLOBAL</button>

            <p id="toggle-modo" onclick="alternarModoLogin()" style="margin-top:25px; font-size:11px; text-decoration:underline; cursor:pointer; color:#888;">
                ¬øYa tienes una misi√≥n? Reingresar
            </p>

            <button onclick="resetIdioma()" style="background:none; border:none; color:#444; margin-top:30px; font-size:9px;">Cambiar Idioma / Change Language</button>
        </div>

        <p id="aviso-login" style="margin-top:20px; font-size:12px; color:var(--naranja); font-weight:bold;"></p>
    </div>

    <div id="capa-ranking" class="capa" style="background: #000; overflow-y: auto;">
        <h2 id="tit-ranking" style="color:var(--naranja); margin-bottom: 15px; letter-spacing: 2px;">RANKING</h2>
        <div id="tabs-ranking" class="tabs-ranking" style="display:none; justify-content:center;">
            <button class="btn-ranking-tab" onclick="verRanking('general')">GLOBAL</button>
            <button class="btn-ranking-tab" onclick="verRanking('grupo')">MI EQUIPO</button>
        </div>
        <table id="tabla-ranking">
            <thead><tr><th>#</th><th>AGENTE</th><th>TIEMPO</th></tr></thead>
            <tbody id="lista-ranking"></tbody>
        </table>
        <button class="btn-mot" onclick="cerrarRanking()" style="border-color: #444; color: #fff;">VOLVER</button>
    </div>

    <div id="capa-tablero" class="capa" style="background: var(--negro); justify-content: flex-start;">
        <div style="position:fixed; top:0; width:100%; background:rgba(0,0,0,0.9); padding:15px; border-bottom:1px solid #222; z-index:100; display: flex; justify-content: center;">
            <span id="txt-saludo" style="color:var(--naranja); font-weight:bold; font-size: 12px; letter-spacing: 1px;"></span>
        </div>
        <div class="timeline" id="timeline-contenedor"></div>
    </div>

    <div id="capa-pista" class="capa" style="padding:0;">
        <div class="split">
            <div class="col-visual">
                <video id="pista-video" playsinline webkit-playsinline></video>
                <button id="btn-play-manual" onclick="forzarPlay()" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); z-index:20; background:rgba(0,0,0,0.7); color:white; border:1px solid white; padding:10px;">REPRODUCIR ‚ñ∂</button>
                <div id="pista-mapa" class="mapa" style="display:none;"></div>
            </div>
            <div class="col-control">
                <h3 id="pista-titulo" style="color:var(--naranja); margin-bottom: 10px; letter-spacing: 2px;"></h3>
                <p id="pista-texto" style="font-size:14px; color:#bbb; margin: 10px 0; line-height: 1.4;"></p>
                <div id="pista-gps-ui" style="display:none; margin: 20px 0;">
                    <div id="pista-distancia" style="font-size:40px; font-weight:bold; color:var(--naranja);">--</div>
                    <p id="txt-metros" style="margin:0; font-size:10px; opacity: 0.6; letter-spacing: 1px;"></p>
                </div>
                <button id="btn-escanear-accion" class="btn-mot" onclick="abrirEscaner()"></button>
                <button id="btn-volver-tablero" class="btn-mot" style="border-color:#333; color:#777; font-size:10px; padding: 10px; margin-top: 10px;" onclick="irATablero()"></button>
            </div>
        </div>
    </div>

    <div id="capa-victoria" class="capa">
        <h1 id="tit-victoria" style="color:var(--verde); font-size:35px; letter-spacing: 2px;"></h1>
        <p id="msj-victoria" style="color: #aaa; margin: 10px 0;"></p>
        <div id="tiempo-total" style="font-size:50px; color:var(--naranja); font-weight:bold; margin: 20px 0;">--:--</div>
        <div style="display:flex; gap:10px; width:100%; max-width:300px; justify-content:center;">
            <button class="btn-mot" onclick="verRanking('general')" style="border-color:#fff; color:#fff; font-size:10px; padding: 10px;">üèÜ GLOBAL</button>
            <button class="btn-mot" onclick="verRanking('grupo')" style="border-color:var(--naranja); color:var(--naranja); font-size:10px; padding: 10px;">üõ°Ô∏è EQUIPO</button>
        </div>
        <button id="btn-nueva" class="btn-mot" onclick="cerrarSesion()" style="border-color:var(--verde); color:var(--verde); margin-top: 30px;"></button>
    </div>

    <div id="scan-overlay">
        <div id="reader"></div>
        <button id="btn-cancelar-scan" class="btn-mot" onclick="cerrarEscaner()" style="border-color:#fff; color:#fff; margin-top:30px;">CANCELAR</button>
    </div>

    <script>
        const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyH058Ipqtju9KZcLGgzM8TFnjOCSaBGIbEHC-kmzjsft2yV77GbagpuiKecE_i1pkX/exec"; 
        const sndBeep = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU..."); 

        const TEXTOS = {
            es: {
                ph_nombre: "Nombre del Agente", ph_clave: "Clave de Misi√≥n", btn_entrar: "INICIAR MISI√ìN",
                btn_recuperar: "CONTINUAR MISI√ìN", toggle_reingreso: "¬øYa tienes una misi√≥n en curso? Reingresar",
                toggle_nuevo: "¬øAgente nuevo? Registrarse aqu√≠", btn_escanear: "üì∏ ESCANEAR OBJETIVO",
                btn_tablero: "VOLVER AL MAPA", btn_cancelar: "CANCELAR", tit_victoria: "¬°MISI√ìN CUMPLIDA!",
                btn_nueva: "FINALIZAR OPERACI√ìN", txt_metros: "METROS AL OBJETIVO", err_qr: "C√ìDIGO INCORRECTO",
                err_code: "C√ìDIGO INV√ÅLIDO O AGOTADO", err_need_name: "IDENTIF√çCATE AGENTE",
                msg_recuperando: "VERIFICANDO CREDENCIALES...", lbl_agente: "AGENTE"
            },
            en: {
                ph_nombre: "Agent Name", ph_clave: "Mission Key", btn_entrar: "START MISSION",
                btn_recuperar: "RESUME MISSION", toggle_reingreso: "Mission in progress? Resume here",
                toggle_nuevo: "New Agent? Register here", btn_escanear: "üì∏ SCAN TARGET",
                btn_tablero: "BACK TO MAP", btn_cancelar: "CANCEL", tit_victoria: "MISSION ACCOMPLISHED!",
                btn_nueva: "END OPERATION", txt_metros: "METERS TO TARGET", err_qr: "WRONG CODE",
                err_code: "INVALID OR EXPIRED CODE", err_need_name: "IDENTIFY YOURSELF AGENT",
                msg_recuperando: "VERIFYING CREDENTIALS...", lbl_agente: "AGENT"
            }
        };

        const PISTAS_DATA = {
            1: { qr: "BARICHARA_PISTA_01", video: "https://www.motmotexperiencias.com/wp-content/uploads/2025/12/Diseno-sin-titulo-3.mp4", es: { titulo: "LA BIENVENIDA", texto: "El agua es vida. Busca la fuente antigua." }, en: { titulo: "THE WELCOME", texto: "Water is life. Find the ancient fountain." } },
            2: { qr: "BARICHARA_PISTA_02", video: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-15.mp4", lat: 6.634477, lon: -73.224308, es: { titulo: "FUNDACI√ìN", texto: "Donde se aprende a construir con tierra. Escuela Taller." }, en: { titulo: "FOUNDATION", texto: "Where building with earth is taught. Workshop School." } },
            3: { qr: "BARICHARA_PISTA_03", video: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-13.mp4", lat: 6.634307, lon: -73.225441, es: { titulo: "TABACO & PAPEL", texto: "Hojas que cuentan historias. Taller de Papel." }, en: { titulo: "TOBACCO & PAPER", texto: "Leaves that tell stories. Paper Workshop." } },
            4: { qr: "BARICHARA_PISTA_04", video: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-13.mp4", es: { titulo: "PISTA 4", texto: "Sigue las instrucciones." }, en: { titulo: "CLUE 4", texto: "Follow instructions." } },
            5: { qr: "BARICHARA_PISTA_05", video: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-13.mp4", es: { titulo: "PISTA 5", texto: "Contin√∫a explorando." }, en: { titulo: "Keep exploring." } },
            6: { qr: "BARICHARA_PISTA_06", video: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-13.mp4", es: { titulo: "PISTA 6", texto: "Ya casi llegas." }, en: { titulo: "Almost there." } },
            7: { qr: "BARICHARA_PISTA_07", video: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-13.mp4", es: { titulo: "PISTA 7", texto: "Observa los detalles." }, en: { titulo: "Watch the details." } },
            8: { qr: "BARICHARA_PISTA_08", video: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-13.mp4", es: { titulo: "PISTA 8", texto: "Un paso m√°s." }, en: { titulo: "One more step." } },
            9: { qr: "BARICHARA_PISTA_09", video: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-13.mp4", es: { titulo: "PISTA 9", texto: "Prep√°rate para el final." }, en: { titulo: "Prepare for the end." } },
            10: { qr: "TESORO_MOTMOT_FINAL", video: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-11.mp4", es: { titulo: "EL TESORO", texto: "¬°Has llegado! Escanea el cofre final." }, en: { titulo: "THE TREASURE", texto: "You made it! Scan the final chest." } }
        };

        const ORDEN = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; 
        let idioma = 'es';
        let nivelActual = 1;
        let qrScanner = null;
        let modoReingreso = false;
        let ultimaCapa = 'capa-login';

        window.onload = () => {
            verificarEstadoPantalla();
            if(localStorage.getItem('motmot_lang')) setLanguage(localStorage.getItem('motmot_lang'), false);
            if(localStorage.getItem('motmot_clave')) iniciarMision(true);
            
            document.addEventListener("fullscreenchange", verificarEstadoPantalla);
            document.addEventListener("webkitfullscreenchange", verificarEstadoPantalla);
        };

        function mostrarAlerta(texto, titulo="AVISO") {
            document.getElementById('alerta-titulo').innerText = titulo;
            document.getElementById('alerta-texto').innerText = texto;
            document.getElementById('capa-alerta').style.display = 'flex';
        }
        function cerrarAlerta() { document.getElementById('capa-alerta').style.display = 'none'; }

        function activarModoInmersivo() {
            let elem = document.documentElement;
            let p;
            if (elem.requestFullscreen) p = elem.requestFullscreen();
            else if (elem.webkitRequestFullscreen) p = elem.webkitRequestFullscreen();
            
            if(p) {
                p.then(() => document.getElementById('capa-fullscreen-request').style.display = 'none')
                 .catch(() => document.getElementById('capa-fullscreen-request').style.display = 'none');
            } else {
                 document.getElementById('capa-fullscreen-request').style.display = 'none';
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) activarModoInmersivo();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        function verificarEstadoPantalla() {
            const isFullScreen = document.fullscreenElement || document.webkitFullscreenElement;
            const capaPausa = document.getElementById('capa-fullscreen-request');
            if (!isFullScreen && window.innerWidth > window.innerHeight) {
                capaPausa.style.display = 'flex';
            } else {
                capaPausa.style.display = 'none';
            }
        }

        function iniciarMision(esRecarga = false) {
            // 1. Disparar Fullscreen primero (Fuego y olvido)
            activarModoInmersivo();

            // 2. L√≥gica de datos (sin bloquearse si el fullscreen falla)
            let nom = document.getElementById('reg-nombre').value.trim();
            const cla = esRecarga ? localStorage.getItem('motmot_clave') : document.getElementById('reg-clave').value.toUpperCase().trim();
            if (esRecarga) nom = localStorage.getItem('motmot_agente');
            
            if (!esRecarga && !modoReingreso && !nom) { mostrarAlerta(TEXTOS[idioma].err_need_name); return; }
            if(!cla) return;
            
            if(esRecarga || modoReingreso) document.getElementById('aviso-login').innerText = TEXTOS[idioma].msg_recuperando;

            ejecutarJSONP(`${URL_GOOGLE}?action=registrar_inicio&codigo=${cla}&nombre=${encodeURIComponent(nom)}`, (data) => {
                if(data.status === "success") {
                    localStorage.setItem('motmot_clave', cla);
                    localStorage.setItem('motmot_agente', data.nombre_jugador);
                    localStorage.setItem('motmot_equipo', data.nombre_equipo);
                    nivelActual = parseInt(data.pista_actual || 1);
                    localStorage.setItem('motmot_pista', nivelActual);
                    if(!esRecarga && data.modo === "reingreso") {
                        mostrarAlerta(`Bienvenido de nuevo Agente ${data.nombre_jugador}`, "REGRESO");
                    }
                    irATablero();
                } else if(!esRecarga) {
                    if (data.code === "ERR_NEED_NAME") mostrarAlerta(TEXTOS[idioma].err_need_name);
                    else if (data.code === "ERR_USED") mostrarAlerta(TEXTOS[idioma].err_code, "ERROR");
                    else document.getElementById('aviso-login').innerText = TEXTOS[idioma].err_code;
                }
            });
        }
        
        function irATablero() {
            // Asegurar que el video anterior muera
            const vid = document.getElementById('pista-video');
            vid.pause(); vid.src = "";
            
            nivelActual = parseInt(localStorage.getItem('motmot_pista') || 1);
            const cont = document.getElementById('timeline-contenedor');
            cont.innerHTML = "";
            const t = TEXTOS[idioma];
            document.getElementById('txt-saludo').innerText = `${t.lbl_agente}: ${localStorage.getItem('motmot_agente')} | ${localStorage.getItem('motmot_equipo')}`;
            ORDEN.forEach(i => {
                const infoPista = PISTAS_DATA[i][idioma];
                const hito = document.createElement('div');
                hito.className = `hito ${i < nivelActual ? 'completado' : (i === nivelActual ? 'actual' : '')}`;
                hito.onclick = () => { if(i <= nivelActual) cargarPista(i); };
                hito.innerHTML = `<div class="bola">${i === 10 ? 'üèÜ' : i}</div><div><b>${infoPista.titulo}</b></div>`;
                cont.appendChild(hito);
            });
            mostrarCapa('capa-tablero');
        }

        function cargarPista(n) {
            detenerGPS(); 
            const data = PISTAS_DATA[n];
            const info = data[idioma];
            const vid = document.getElementById('pista-video');
            const btnPlay = document.getElementById('btn-play-manual');
            
            // RESET VIDEO ROBUSTO
            vid.pause();
            vid.src = "";
            vid.load();
            btnPlay.style.display = "none";
            
            document.getElementById('pista-titulo').innerText = info.titulo;
            document.getElementById('pista-texto').innerText = info.texto;
            
            document.getElementById('pista-mapa').style.display = "none";
            document.getElementById('pista-gps-ui').style.display = "none"; 
            
            mostrarCapa('capa-pista');

            // Retraso para asegurar DOM listo
            setTimeout(() => {
                vid.src = data.video;
                vid.style.display = "block";
                
                let playPromise = vid.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // Reproducci√≥n autom√°tica OK
                    })
                    .catch(error => {
                        console.log("Autoplay prevenido, mostrando bot√≥n manual");
                        btnPlay.style.display = "block"; // Mostrar bot√≥n si falla
                    });
                }
            }, 100);

            if(data.lat) iniciarGPS(data.lat, data.lon);
        }

        function forzarPlay() {
            const vid = document.getElementById('pista-video');
            vid.play();
            document.getElementById('btn-play-manual').style.display = "none";
        }

        function abrirEscaner() {
            document.getElementById('scan-overlay').style.display = 'flex';
            if(!qrScanner) qrScanner = new Html5Qrcode("reader");
            qrScanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 280 }, (text) => {
                if(text.trim() === PISTAS_DATA[nivelActual].qr) { cerrarEscaner(); reproducirEfectoScan(); exitoPista(); } 
                else { mostrarAlerta(TEXTOS[idioma].err_qr); cerrarEscaner(); }
            }).catch(e => console.log(e));
        }

        function reproducirEfectoScan() {
            try { sndBeep.play(); } catch(e){}
            const flash = document.getElementById('flash-effect');
            flash.style.opacity = '1';
            setTimeout(() => { flash.style.opacity = '0'; }, 300);
        }

        function exitoPista() {
            if(nivelActual === 10) { mostrarCapa('capa-victoria'); finalizarMision(); } 
            else {
                let idx = ORDEN.indexOf(nivelActual);
                nivelActual = ORDEN[idx + 1];
                localStorage.setItem('motmot_pista', nivelActual);
                irATablero(); 
                ejecutarJSONP(`${URL_GOOGLE}?action=guardar_progreso&codigo=${localStorage.getItem('motmot_clave')}&pista=${nivelActual}`, (res) => { console.log('Guardado OK'); });
            }
        }

        function verRanking(filtro) {
            ultimaCapa = document.querySelector('.capa.activa').id;
            mostrarCapa('capa-ranking');
            const lista = document.getElementById('lista-ranking');
            lista.innerHTML = "<tr><td colspan='3'>Conectando con base de datos...</td></tr>";
            let url = `${URL_GOOGLE}?action=obtener_ranking`;
            let titulo = "RANKING GLOBAL";
            if (filtro === 'grupo') {
                const miEquipo = localStorage.getItem('motmot_equipo');
                if (!miEquipo) { mostrarAlerta("Inicia sesi√≥n para ver tu equipo"); verRanking('general'); return; }
                url += `&grupo=${encodeURIComponent(miEquipo)}`;
                titulo = `RANKING: ${miEquipo}`;
                document.getElementById('tabs-ranking').style.display = 'flex';
            } else {
                document.getElementById('tabs-ranking').style.display = localStorage.getItem('motmot_clave') ? 'flex' : 'none';
            }
            document.getElementById('tit-ranking').innerText = titulo;
            ejecutarJSONP(url, (data) => {
                if(data.status === "success") {
                    lista.innerHTML = "";
                    if(data.ranking.length === 0) lista.innerHTML = "<tr><td colspan='3'>Sin registros a√∫n.</td></tr>";
                    data.ranking.forEach((jugador, index) => {
                        let t = jugador.tiempo ? jugador.tiempo + " min" : "--";
                        lista.innerHTML += `<tr><td class="pos">${index + 1}</td><td>${jugador.nombre}<br><small style="color:#666">${jugador.grupo}</small></td><td>${t}</td></tr>`;
                    });
                } else { lista.innerHTML = "<tr><td colspan='3'>Error de conexi√≥n.</td></tr>"; }
            });
        }

        function finalizarMision() {
            const codigo = localStorage.getItem('motmot_clave');
            ejecutarJSONP(`${URL_GOOGLE}?action=registrar_fin&codigo=${codigo}`, (data) => {
                const tiempoTexto = (data.tiempo && !isNaN(data.tiempo)) ? `${data.tiempo} MIN` : "-- MIN";
                document.getElementById('tiempo-total').innerText = tiempoTexto;
                document.getElementById('msj-victoria').innerText = (idioma === 'es') ? `¬°GRAN TRABAJO AGENTE!` : `GREAT JOB AGENT!`;
            });
        }

        function mostrarCapa(id) { document.querySelectorAll('.capa').forEach(c => c.classList.remove('activa')); document.getElementById(id).classList.add('activa'); }
        function cerrarRanking() { mostrarCapa(ultimaCapa); }
        function alternarModoLogin() {
            modoReingreso = !modoReingreso;
            const t = TEXTOS[idioma];
            document.getElementById('reg-nombre').className = modoReingreso ? 'oculto' : '';
            document.getElementById('btn-entrar').innerText = modoReingreso ? t.btn_recuperar : t.btn_entrar;
            document.getElementById('toggle-modo').innerText = modoReingreso ? t.toggle_nuevo : t.toggle_reingreso;
        }
        function setLanguage(lang) {
            idioma = lang; localStorage.setItem('motmot_lang', lang);
            const t = TEXTOS[lang];
            document.getElementById('reg-nombre').placeholder = t.ph_nombre;
            document.getElementById('reg-clave').placeholder = t.ph_clave;
            document.getElementById('btn-entrar').innerText = modoReingreso ? t.btn_recuperar : t.btn_entrar;
            document.getElementById('btn-escanear-accion').innerText = t.btn_escanear;
            document.getElementById('btn-volver-tablero').innerText = t.btn_tablero;
            document.getElementById('tit-victoria').innerText = t.tit_victoria;
            document.getElementById('btn-nueva').innerText = t.btn_nueva;
            document.getElementById('paso-idioma').style.display = 'none';
            document.getElementById('paso-form').style.display = 'flex';
        }

        let map, watchID;
        function detenerGPS() {
            if(watchID) { navigator.geolocation.clearWatch(watchID); watchID = null; }
            if(map) { map.remove(); map = null; }
        }
        function iniciarGPS(tLat, tLon) {
            document.getElementById('pista-video').style.display = "none";
            document.getElementById('pista-mapa').style.display = "block";
            document.getElementById('pista-gps-ui').style.display = "block";
            detenerGPS();
            map = L.map('pista-mapa', {zoomControl: false}).setView([tLat, tLon], 18);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([tLat, tLon]).addTo(map);
            watchID = navigator.geolocation.watchPosition(pos => {
                const d = calcularDistancia(pos.coords.latitude, pos.coords.longitude, tLat, tLon);
                document.getElementById('pista-distancia').innerText = Math.round(d);
            }, null, {enableHighAccuracy: true});
        }
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const a = Math.sin((lat2-lat1)*Math.PI/360)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin((lon2-lon1)*Math.PI/360)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function ejecutarJSONP(url, callback) {
            const cbName = 'jsonp_' + Math.round(100000 * Math.random());
            window[cbName] = (data) => { delete window[cbName]; document.body.removeChild(script); callback(data); };
            const script = document.createElement('script');
            script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + cbName;
            document.body.appendChild(script);
        }
        function cerrarEscaner() { if(qrScanner) qrScanner.stop().then(() => { document.getElementById('scan-overlay').style.display = 'none'; }); }
        function cerrarSesion() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
