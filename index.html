<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Centro de Mando | MotMot</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --naranja: #ff6600; --verde: #00cc66; --negro: #000; --gris: #111; --dorado: #FFD700; }
        body, html { margin: 0; padding: 0; background: var(--negro); color: white; height: 100dvh; font-family: 'Verdana', sans-serif; overflow: hidden; }

        /* --- CAPAS --- */
        .capa { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: var(--negro); z-index: 10; padding: 20px; text-align: center; }
        .activa { display: flex !important; }

        /* --- ESTILOS VISUALES --- */
        .titulo { font-size: 24px; letter-spacing: 3px; color: var(--naranja); text-transform: uppercase; margin-bottom: 10px; }
        .subtitulo { font-size: 10px; letter-spacing: 4px; opacity: 0.7; text-transform: uppercase; margin-bottom: 30px; }
        
        .btn-mot { 
            background: transparent; border: 2px solid var(--naranja); color: var(--naranja); 
            padding: 15px 40px; border-radius: 50px; font-weight: bold; cursor: pointer; 
            text-transform: uppercase; font-size: 14px; letter-spacing: 2px; transition: 0.3s;
            margin-top: 20px; width: 100%; max-width: 300px;
        }
        .btn-mot:active { background: var(--naranja); color: #000; transform: scale(0.95); }

        input { background: transparent; border: none; border-bottom: 2px solid #666; color: white; padding: 12px; margin: 10px 0; width: 100%; max-width: 300px; text-align: center; font-size: 18px; outline: none; }
        
        /* --- ESTILOS DEL RANKING (FINAL) --- */
        .copa-animada { font-size: 80px; animation: bounce 2s infinite; margin-bottom: 20px; }
        .stats-box { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--dorado); border-radius: 10px; padding: 20px; width: 100%; max-width: 350px; margin-bottom: 20px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .stat-label { color: #aaa; font-size: 12px; text-transform: uppercase; }
        .stat-val { color: var(--dorado); font-weight: bold; font-size: 14px; }
        
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }

        /* ESCANER */
        #reader { width: 100%; max-width: 400px; border: 2px solid var(--naranja); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="capa-login" class="capa activa">
        <div class="subtitulo">BARICHARA</div>
        <div class="titulo">B√öSQUEDA DEL TESORO</div>
        <p style="font-size: 10px; color: #666;">MOTMOT EXPERIENCIAS</p>
        
        <input type="text" id="reg-nombre" placeholder="Nombre de Agente">
        <input type="text" id="reg-clave" placeholder="Clave de Misi√≥n">
        <button class="btn-mot" onclick="iniciarLogin()">INICIAR SISTEMA</button>
        <p id="msg-login" style="margin-top:15px; font-size:11px; color:var(--naranja);"></p>
    </div>

    <div id="capa-tablero" class="capa">
        <p class="subtitulo" style="color:var(--verde);">ESTADO DE MISI√ìN</p>
        <h1 id="txt-nivel" style="font-size:40px; color:white; margin:10px 0;">PISTA 1</h1>
        <p id="txt-instruccion" style="font-size:12px; color:#ccc; max-width:80%; line-height:1.5;">
            El sistema ha cargado los datos de tu siguiente objetivo.
        </p>
        
        <button id="btn-accion-principal" class="btn-mot" onclick="ejecutarAccionNivel()">CARGANDO...</button>
    </div>

    <div id="capa-escaner" class="capa" style="background:rgba(0,0,0,0.95);">
        <p class="subtitulo">LECTOR QR ACTIVADO</p>
        <div id="reader"></div>
        <button class="btn-mot" style="border-color:#555; color:#888; margin-top:20px;" onclick="cerrarEscaner()">CANCELAR</button>
    </div>

    <div id="capa-ranking" class="capa" style="background: linear-gradient(to bottom, #111, #000);">
        <div class="copa-animada">üèÜ</div>
        <h2 style="color:var(--dorado); letter-spacing:4px; margin:0;">¬°VICTORIA!</h2>
        <p style="font-size:10px; color:#888; margin-bottom:30px;">TESORO ENCONTRADO</p>

        <div class="stats-box">
            <div class="stat-row">
                <span class="stat-label">Agente</span>
                <span class="stat-val" id="rank-nombre">---</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Equipo</span>
                <span class="stat-val" id="rank-equipo">---</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Tiempo Total</span>
                <span class="stat-val" id="rank-tiempo">CALCULANDO...</span>
            </div>
            <div class="stat-row" style="border:none;">
                <span class="stat-label">Rango</span>
                <span class="stat-val" style="color:var(--verde);">MAESTRO EXPLORADOR</span>
            </div>
        </div>

        <p style="font-size:10px; color:#555; max-width:80%;">Dir√≠gete al punto de encuentro para reclamar tu recompensa.</p>
        <button class="btn-mot" onclick="location.reload()">FINALIZAR</button>
    </div>

<script>
    // --- 1. CONFIGURACI√ìN DE URLS (EL ENRUTADOR) ---
    // AQU√ç DEBES PEGAR LOS LINKS REALES DE TUS P√ÅGINAS DE WORDPRESS
    const CONFIGURACION_URLS = {
        1: "https://www.motmotexperiencias.com/pista-1/", // Link a tu p√°gina de Pista 1
        2: "https://www.motmotexperiencias.com/pista-2/",
        3: "https://www.motmotexperiencias.com/pista-3/",
        4: "https://www.motmotexperiencias.com/pista-4/",
        5: "https://www.motmotexperiencias.com/pista-5/",
        // Si tienes m√°s p√°ginas (6, 7, 8, 9), ponlas aqu√≠.
        // Si no tienes p√°gina para la 6, el sistema usar√° el esc√°ner gen√©rico.
    };

    const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyH058Ipqtju9KZcLGgzM8TFnjOCSaBGIbEHC-kmzjsft2yV77GbagpuiKecE_i1pkX/exec"; 
    const NIVEL_FINAL = 10; // El nivel del Tesoro
    const CODIGO_TESORO = "TESORO_MOTMOT_FINAL";

    let html5QrCode;
    let nivelActual = 1;

    window.onload = () => {
        // Verificar si ya hay sesi√≥n
        if(localStorage.getItem('motmot_clave')) {
            nivelActual = parseInt(localStorage.getItem('motmot_pista') || 1);
            // Si ya termin√≥, mostrar ranking directamente
            if(nivelActual > NIVEL_FINAL) {
                mostrarRanking();
            } else {
                mostrarTablero();
            }
        }
    };

    // --- L√ìGICA DE LOGIN (Conservada) ---
    function iniciarLogin() {
        const nombre = document.getElementById('reg-nombre').value;
        const clave = document.getElementById('reg-clave').value.toUpperCase();
        
        if(!nombre || !clave) { alert("Faltan datos"); return; }
        
        document.getElementById('msg-login').innerText = "CONECTANDO CON SAT√âLITE...";
        
        // Guardar hora de inicio si es nuevo
        if(!localStorage.getItem('motmot_inicio')) {
            localStorage.setItem('motmot_inicio', new Date().getTime());
        }

        // Simulamos llamada a Google (o usa tu fetch real)
        ejecutarJSONP(`${URL_GOOGLE}?action=registrar_inicio&codigo=${clave}&nombre=${encodeURIComponent(nombre)}`, (data) => {
            if(data.status === "success") {
                localStorage.setItem('motmot_clave', clave);
                localStorage.setItem('motmot_agente', data.nombre_jugador || nombre);
                localStorage.setItem('motmot_equipo', data.nombre_equipo || "Exploradores");
                localStorage.setItem('motmot_pista', data.pista_actual || 1);
                
                nivelActual = parseInt(data.pista_actual || 1);
                mostrarTablero();
            } else {
                document.getElementById('msg-login').innerText = "ERROR DE CREDENCIALES";
            }
        });
    }

    // --- L√ìGICA DEL TABLERO (CEREBRO) ---
    function mostrarTablero() {
        ocultarTodo();
        document.getElementById('capa-tablero').classList.add('activa');
        
        const btn = document.getElementById('btn-accion-principal');
        const titulo = document.getElementById('txt-nivel');
        const instruccion = document.getElementById('txt-instruccion');

        if (nivelActual === NIVEL_FINAL) {
            // ESTAMOS EN EL TESORO
            titulo.innerText = "EL TESORO";
            titulo.style.color = "var(--dorado)";
            instruccion.innerText = "Has llegado al final. Encuentra el cofre y escanea su c√≥digo final.";
            btn.innerText = "ESCANEAR TESORO";
            btn.onclick = abrirEscanerTesoro; // Funci√≥n especial para el final
        } 
        else if (CONFIGURACION_URLS[nivelActual]) {
            // ES UNA PISTA CON PAGINA WEB (1 a 5)
            titulo.innerText = "PISTA " + nivelActual;
            instruccion.innerText = "La informaci√≥n de esta pista requiere una interfaz inmersiva.";
            btn.innerText = "ABRIR PISTA " + nivelActual;
            btn.onclick = () => {
                window.location.href = CONFIGURACION_URLS[nivelActual];
            };
        } 
        else {
            // ES UNA PISTA SIN PAGINA (Usar esc√°ner gen√©rico del cerebro)
            titulo.innerText = "PISTA " + nivelActual;
            instruccion.innerText = "Busca el c√≥digo QR f√≠sico en la ubicaci√≥n.";
            btn.innerText = "ESCANEAR C√ìDIGO";
            btn.onclick = abrirEscanerGenerico;
        }
    }

    // --- ESC√ÅNER PARA PISTAS GEN√âRICAS (6-9) ---
    function abrirEscanerGenerico() {
        document.getElementById('capa-tablero').classList.remove('activa');
        document.getElementById('capa-escaner').classList.add('activa');
        iniciarCamara((texto) => {
            // Validar c√≥digo gen√©rico (Ej: BARICHARA_PISTA_06)
            if(texto.includes("PISTA_0" + nivelActual) || texto.includes("PISTA_" + nivelActual)) {
                alert("¬°CORRECTO!");
                avanzarNivel();
            }
        });
    }

    // --- ESC√ÅNER PARA EL TESORO (NIVEL 10) ---
    function abrirEscanerTesoro() {
        document.getElementById('capa-tablero').classList.remove('activa');
        document.getElementById('capa-escaner').classList.add('activa');
        iniciarCamara((texto) => {
            if(texto.includes(CODIGO_TESORO)) {
                cerrarEscaner();
                mostrarRanking();
                // Opcional: Enviar datos de fin a Google Sheets aqu√≠
            }
        });
    }

    // --- UTILS ESC√ÅNER ---
    function iniciarCamara(callbackExito) {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (texto) => { callbackExito(texto); }
        ).catch(err => alert("Error c√°mara"));
    }
    
    function cerrarEscaner() {
        if(html5QrCode) html5QrCode.stop().then(() => {
            document.getElementById('capa-escaner').classList.remove('activa');
            document.getElementById('capa-tablero').classList.add('activa');
        });
    }

    // --- LOGICA DE AVANCE ---
    function avanzarNivel() {
        nivelActual++;
        localStorage.setItem('motmot_pista', nivelActual);
        if(html5QrCode) html5QrCode.stop();
        mostrarTablero();
    }

    // --- PANTALLA DE RANKING ---
    function mostrarRanking() {
        ocultarTodo();
        document.getElementById('capa-ranking').classList.add('activa');
        
        // Cargar datos
        document.getElementById('rank-nombre').innerText = localStorage.getItem('motmot_agente') || "An√≥nimo";
        document.getElementById('rank-equipo').innerText = localStorage.getItem('motmot_equipo') || "Solo";
        
        // Calcular tiempo
        const inicio = parseInt(localStorage.getItem('motmot_inicio'));
        const fin = new Date().getTime();
        
        if(inicio) {
            const totalSegundos = Math.floor((fin - inicio) / 1000);
            const minutos = Math.floor(totalSegundos / 60);
            const segundos = totalSegundos % 60;
            document.getElementById('rank-tiempo').innerText = `${minutos} min ${segundos} seg`;
        } else {
            document.getElementById('rank-tiempo').innerText = "NO REGISTRADO";
        }

        // Bloquear regreso
        localStorage.setItem('motmot_pista', 11); 
    }

    function ocultarTodo() {
        const capas = document.querySelectorAll('.capa');
        capas.forEach(c => c.classList.remove('activa'));
    }

    function ejecutarJSONP(url, callback) {
        const cbName = 'jsonp_' + Math.round(100000 * Math.random());
        window[cbName] = (data) => { delete window[cbName]; document.body.removeChild(script); callback(data); };
        const script = document.createElement('script');
        script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + cbName;
        document.body.appendChild(script);
    }
</script>
</body>
</html>
