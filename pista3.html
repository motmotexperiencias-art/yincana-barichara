<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>Misi√≥n 4 | El Descanso</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body, html { margin: 0; padding: 0; background: #000; color: white; height: 100vh; width: 100vw; font-family: 'Verdana', sans-serif; overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* --- LAYOUT DIVIDIDO (SPLIT SCREEN) --- */
        #app-juego { 
            position: fixed; inset: 0; z-index: 10; display: flex; flex-direction: row; 
            background: #000;
        }

        /* COLUMNA IZQUIERDA (CONTENIDO) */
        .col-juego { 
            flex: 1; position: relative; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; background: #080808; 
            border-right: 2px solid #222; overflow-y: auto; padding: 20px;
        }

        /* COLUMNA DERECHA (MAPA) */
        .col-mapa { 
            flex: 1; position: relative; display: flex; 
        }

        /* M√ìVIL VERTICAL (ESCONDER MAPA) */
        @media screen and (max-width: 768px) and (orientation: portrait) {
            #app-juego { flex-direction: column; }
            .col-mapa { display: none; } /* En vertical enfocamos en el contenido */
            .col-juego { border-right: none; width: 100%; }
        }

        /* --- MAPA LEAFLET --- */
        #mapa-cementerio { width: 100%; height: 100%; filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }

        /* --- BARRA DE PROGRESO --- */
        .progress-container { width: 100%; display: flex; justify-content: center; margin-bottom: 20px; }
        .progress-bar { display: flex; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; border: 1px solid #444; transition: 0.3s; }
        .dot.passed { background: #00cc66; border-color: #00cc66; box-shadow: 0 0 5px rgba(0,204,102,0.5); }
        .dot.active { background: #ff6600; border-color: #ff6600; transform: scale(1.3); box-shadow: 0 0 10px #ff6600; }
        .dot.future { background: transparent; }

        /* --- ESTILOS VISUALES JUEGO --- */
        .etiqueta-evidencia {
            background: #ff6600; color: #000; font-weight: 900; padding: 6px 15px; 
            display: inline-block; text-transform: uppercase; letter-spacing: 2px; 
            font-size: 11px; border-radius: 5px; margin-bottom: 15px; box-shadow: 0 0 15px rgba(255,102,0,0.3);
        }

        .caja-contenedor {
            width: 100%; max-width: 400px; border: 1px solid #333; background: #111; 
            border-radius: 15px; overflow: hidden; padding: 15px; text-align: center;
        }

        .video-evidencia { width: 100%; border-radius: 10px; display: none; aspect-ratio: 9/16; object-fit: cover; }
        .video-evidencia.activo { display: block; }

        .btn-motmot { 
            background: transparent; border: 2px solid #ff6600; color: #ff6600; 
            padding: 12px 30px; border-radius: 50px; cursor: pointer; text-transform: uppercase; 
            letter-spacing: 2px; font-size: 11px; font-weight: bold; transition: 0.3s; margin-top: 15px; width: 100%;
        }
        .btn-motmot:active { background: #ff6600; color: #000; }

        .btn-opcion-azul { 
            background: #1a1a1a; border: 1px solid #444; color: white; padding: 12px; 
            font-size: 13px; border-radius: 8px; cursor: pointer; width: 100%; margin-bottom: 8px; 
            transition: 0.3s; text-align: left;
        }
        .btn-opcion-azul:active { border-color: #0055ff; background: #001133; }

        /* --- ESC√ÅNER --- */
        #scan-container { position: relative; width: 100%; height: 250px; background: black; overflow: hidden; border-radius: 10px; border: 2px solid #333; }
        #reader { width: 100%; height: 100%; }
        .laser { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #ff6600; box-shadow: 0 0 10px #ff6600; animation: scan 2s infinite; z-index: 10; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        /* --- CAPAS DE AVISO (PAUSA) --- */
        #aviso-pausa { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; 
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; 
        }

        #flash-efecto { display: none; position: fixed; inset: 0; background: white; z-index: 10000; pointer-events: none; }
    </style>
</head>
<body>

    <div id="aviso-pausa">
        <h2 style="color:#ff6600; margin-bottom:10px;">JUEGO EN PAUSA</h2>
        <p style="color:#ccc; font-size:12px; margin-bottom:20px;">Has salido de la Misi√≥n. Toca para continuar.</p>
        <button class="btn-motmot" style="width: auto;" onclick="reanudarJuego()">CONTINUAR MISI√ìN</button>
    </div>

    <div id="flash-efecto"></div>
    <audio id="musica-ambiente" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/terror-ambience-7003.mp3" loop></audio>
    <audio id="snd-exito" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/mixkit-church-bell-calling-603.wav"></audio>

    <div id="app-juego">
        
        <div class="col-juego">
            
            <div class="progress-container"><div class="progress-bar">
                <div class="dot passed"></div> <div class="dot passed"></div> <div class="dot passed"></div> <div class="dot active"></div> <div class="dot future"></div> 
            </div></div>

            <div id="fase-inicio" class="caja-contenedor" style="border:none; background:transparent;">
                <div style="font-size: 50px; color:#ff6600; margin-bottom:20px;">‚ò†Ô∏è</div>
                <div class="etiqueta-evidencia">PISTA #4: EL DESCANSO</div>
                <p style="color:#ccc; font-size:12px; margin-bottom:20px;">"Donde el silencio habla m√°s fuerte que las palabras. Dir√≠gete a las coordenadas marcadas en el mapa."</p>
                <button class="btn-motmot" onclick="iniciarMision()">INICIAR AN√ÅLISIS</button>
            </div>

            <div id="seccion-videos" style="display:none; width:100%; flex-direction:column; align-items:center;">
                <div class="etiqueta-evidencia">EVIDENCIA VISUAL</div>
                <div class="caja-contenedor">
                    <video id="vid1" class="video-evidencia activo" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/PISTA4-5.mp4" playsinline muted loop></video>
                    <video id="vid2" class="video-evidencia" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/PISTA4-2.mp4" playsinline muted loop></video>
                    <video id="vid3" class="video-evidencia" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/PISTA4-1.mp4" playsinline muted loop></video>
                    <video id="vid4" class="video-evidencia" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/PISTA4-4.mp4" playsinline muted loop></video>
                    <video id="vid5" class="video-evidencia" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/PISTA4-6_compressed.mp4" playsinline muted loop></video>
                    
                    <button id="btn-next" class="btn-motmot" onclick="siguienteVideo()">SIGUIENTE PRUEBA >></button>
                </div>
            </div>

            <div id="seccion-escaner" style="display:none; width:100%; flex-direction:column; align-items:center;">
                <div class="etiqueta-evidencia">BUSCAR C√ìDIGO</div>
                <div class="caja-contenedor">
                    <p style="font-size:12px; color:#ccc; margin-bottom:10px;">Busca el c√≥digo en la entrada o alrededores.</p>
                    <div id="scan-container">
                        <div id="reader"></div>
                        <div class="laser"></div>
                    </div>
                    <button id="btn-activar" class="btn-motmot" onclick="activarCamara()">ENCENDER C√ÅMARA</button>
                    <p style="margin-top:10px; font-size:10px; color:#444; text-decoration:underline; cursor:pointer;" onclick="irAValidacionFisica()">Saltar (Debug)</p>
                </div>
            </div>

            <div id="quiz-ventanas" style="display:none; width:100%; flex-direction:column; align-items:center;">
                <div class="etiqueta-evidencia">PRUEBA DE CAMPO I</div>
                <div class="caja-contenedor">
                    <p style="font-size:14px; margin-bottom:20px;">Analiza la fachada frontal de piedra.<br><br><strong>¬øCu√°ntas ventanas tiene?</strong></p>
                    <button class="btn-opcion-azul" onclick="checkVentanas(7)">7 VENTANAS</button>
                    <button class="btn-opcion-azul" onclick="checkVentanas(6)">6 VENTANAS</button>
                    <button class="btn-opcion-azul" onclick="checkVentanas(8)">8 VENTANAS</button>
                </div>
            </div>

            <div id="quiz-angel" style="display:none; width:100%; flex-direction:column; align-items:center;">
                <div class="etiqueta-evidencia">PRUEBA DE CAMPO II</div>
                <div class="caja-contenedor">
                    <p style="font-size:14px; margin-bottom:20px;">Frente al cementerio, a la derecha, sobre los muros exteriores...<br><br><strong>¬øQu√© figura destaca?</strong></p>
                    <button class="btn-opcion-azul" onclick="checkAngel(true)">üëº Un √Ångel tallado</button>
                    <button class="btn-opcion-azul" onclick="checkAngel(false)">üî® Un Martillo</button>
                    <button class="btn-opcion-azul" onclick="checkAngel(false)">‚≠ê Una Estrella</button>
                </div>
            </div>

            <div id="quiz-final" style="display:none; width:100%; flex-direction:column; align-items:center;">
                <div class="etiqueta-evidencia">IDENTIDAD MAESTRA</div>
                <div class="caja-contenedor">
                    <p style="font-size:14px; margin-bottom:20px;">Mira la parte superior del arco de la puerta principal.<br><br><strong>¬øQu√© s√≠mbolo corona la entrada?</strong></p>
                    <button class="btn-opcion-azul" onclick="validarFinal(true, this)">‚úùÔ∏è La Cruz de Piedra</button>
                    <button class="btn-opcion-azul" onclick="validarFinal(false, this)">üïäÔ∏è Una Paloma</button>
                </div>
            </div>

        </div>

        <div class="col-mapa">
            <div id="mapa-cementerio"></div>
            <div style="position:absolute; bottom:20px; left:20px; background:rgba(0,0,0,0.8); padding:10px; border-left:3px solid #ff6600; z-index:999;">
                <strong style="color:#ff6600; font-size:12px;">UBICACI√ìN OBJETIVO</strong><br>
                <span style="font-size:10px;">Cementerio de Barichara<br>Cra. 7 #21 a 2-77</span>
            </div>
        </div>

    </div>

<script>
    // --- CONFIGURACI√ìN ---
    const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyH058Ipqtju9KZcLGgzM8TFnjOCSaBGIbEHC-kmzjsft2yV77GbagpuiKecE_i1pkX/exec";
    const CEMENTERIO_COORDS = { lat: 6.637370, lon: -73.227285 }; // Coordenadas aproximadas Cementerio Barichara

    let videoIndex = 1;
    let html5QrCode;
    let musica = document.getElementById('musica-ambiente');
    let map;

    // --- CARGA Y GUARDI√ÅN ---
    window.onload = () => {
        verificarPantalla();
        window.addEventListener("resize", verificarPantalla);
        // Inicializar mapa aunque est√© oculto en m√≥vil (por si giran el cel)
        initMap(); 
        
        // Anti-salida (Solo activamos la pausa si pierden foco, no por rotaci√≥n)
        document.addEventListener("visibilitychange", () => {
             if (document.hidden) document.getElementById('aviso-pausa').style.display = 'flex';
        });
    };

    function verificarPantalla() {
        // En esta pista NO bloqueamos rotaci√≥n, permitimos ambas.
        // Solo verificamos fullscreen si es m√≥vil.
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isFullScreen = document.fullscreenElement || document.webkitFullscreenElement;
        
        if (isMobile && !isFullScreen && document.getElementById('fase-inicio').style.display === 'none') {
            // Solo mostramos pausa si ya empez√≥ el juego y perdi√≥ fullscreen
             document.getElementById('aviso-pausa').style.display = 'flex';
        }
    }

    function reanudarJuego() {
        let el = document.documentElement;
        if(el.requestFullscreen) el.requestFullscreen().catch(e=>{});
        else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen().catch(e=>{});
        document.getElementById('aviso-pausa').style.display = 'none';
        musica.play();
    }

    // --- MAPA LEAFLET ---
    function initMap() {
        map = L.map('mapa-cementerio', { zoomControl: false, attributionControl: false }).setView([CEMENTERIO_COORDS.lat, CEMENTERIO_COORDS.lon], 17);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        // Marcador Personalizado
        const icon = L.divIcon({ 
            html: '<div style="background:#ff6600; width:15px; height:15px; border-radius:50%; border:2px solid white; box-shadow: 0 0 15px #ff6600;"></div>', 
            className: '' 
        });
        L.marker([CEMENTERIO_COORDS.lat, CEMENTERIO_COORDS.lon], {icon: icon}).addTo(map)
        .bindPopup("Cementerio de Barichara").openPopup();
    }

    // --- L√ìGICA JUEGO ---
    function iniciarMision() {
        reanudarJuego(); // Activa fullscreen y audio
        document.getElementById('fase-inicio').style.display = "none";
        document.getElementById('seccion-videos').style.display = "flex";
        document.getElementById('vid1').play();
    }

    function siguienteVideo() {
        if(videoIndex < 5) {
            let actual = document.getElementById('vid'+videoIndex);
            actual.pause();
            actual.classList.remove('activo');
            
            videoIndex++;
            let next = document.getElementById('vid'+videoIndex);
            next.classList.add('activo');
            next.play();

            if(videoIndex === 5) document.getElementById('btn-next').innerText = "FINALIZAR AN√ÅLISIS";
        } else {
            document.getElementById('seccion-videos').style.display = "none";
            document.getElementById('seccion-escaner').style.display = "flex";
        }
    }

    // --- ESC√ÅNER ---
    function activarCamara() {
        document.getElementById('btn-activar').style.display = "none";
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 15, qrbox: { width: 250, height: 250 } }, 
            (text) => {
                if(text.toUpperCase().includes("PISTA_04") || text.toUpperCase().includes("BARICHARA")) {
                    html5QrCode.stop().then(() => irAValidacionFisica());
                }
            }
        ).catch(err => { 
            alert("Error c√°mara. Usa 'Saltar'."); 
            document.getElementById('btn-activar').style.display = "block"; 
        });
    }

    function irAValidacionFisica() {
        if(html5QrCode && html5QrCode.isScanning) { html5QrCode.stop(); }
        document.getElementById('seccion-escaner').style.display = "none";
        document.getElementById('quiz-ventanas').style.display = "flex";
    }

    // --- QUIZZES ---
    function checkVentanas(num) {
        if(num === 7) {
            document.getElementById('quiz-ventanas').style.display = "none";
            document.getElementById('quiz-angel').style.display = "flex";
        } else { alert("Incorrecto. Cuenta bien las ventanas frontales."); }
    }

    function checkAngel(isCorrect) {
        if(isCorrect) {
            document.getElementById('quiz-angel').style.display = "none";
            document.getElementById('quiz-final').style.display = "flex";
        } else { alert("Incorrecto. Busca en el muro derecho exterior."); }
    }

    function validarFinal(ok, el) {
        if(ok) {
            el.style.background = "#27ae60";
            document.getElementById('flash-efecto').style.display = "block";
            document.getElementById('snd-exito').play();
            musica.pause();

            // Guardar Progreso (Pista 5)
            localStorage.setItem('motmot_pista', 5); 

            // Google Sheets
            const usuario = localStorage.getItem('motmot_clave');
            if(usuario) {
                const urlFinal = `${URL_GOOGLE}?action=guardar_progreso&codigo=${usuario}&pista=5`;
                ejecutarJSONP(urlFinal, () => {
                     setTimeout(() => { window.location.href = "index.html"; }, 3000);
                });
            } else {
                setTimeout(() => { window.location.href = "index.html"; }, 3000);
            }

        } else {
            el.style.background = "#c0392b";
            setTimeout(() => { el.style.background = "#1a1a1a"; }, 1000);
        }
    }

    function ejecutarJSONP(url, callback) {
        const cbName = 'jsonp_' + Math.round(100000 * Math.random());
        window[cbName] = (data) => { delete window[cbName]; document.body.removeChild(script); callback(data); };
        const script = document.createElement('script');
        script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + cbName;
        document.body.appendChild(script);
    }
</script>
</body>
</html>
