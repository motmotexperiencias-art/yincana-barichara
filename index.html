<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <title>BÃºsqueda del Tesoro | Barichara</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root { --naranja: #ff6600; --verde: #00cc66; --negro: #000; --gris: #111; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { margin: 0; padding: 0; background: var(--negro); color: white; height: 100dvh; width: 100vw; font-family: 'Verdana', sans-serif; overflow: hidden; }

        /* Capas Generales: AJUSTE DE MARGENES VERTICALES */
        .capa { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100dvh; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            /* Reducimos padding vertical drasticamente para que quepa en landscape */
            padding: 10px 40px; 
            padding-left: max(40px, env(safe-area-inset-left)); 
            padding-right: max(40px, env(safe-area-inset-right));
            text-align: center; z-index: 10; background: var(--negro); 
            /* Scroll de seguridad por si la pantalla es muy bajita */
            overflow-y: auto; 
        }
        .activa { display: flex !important; }
        
        /* Contenedor central */
        .contenido-central {
            width: 100%;
            max-width: 500px;
            display: flex; flex-direction: column; align-items: center;
            /* Asegura que si hay scroll, el contenido tenga margen abajo */
            padding-bottom: 20px; 
        }

        .video-bg { position: absolute; z-index: -1; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.4; filter: brightness(0.7); }

        /* Botones: Margen superior reducido */
        .btn-mot { 
            background: transparent; border: 2px solid var(--naranja); color: var(--naranja); 
            padding: 12px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; 
            text-transform: uppercase; width: auto; min-width: 220px; font-size: 14px; 
            margin-top: 15px; /* Reducido de 25px */
            transition: 0.3s; letter-spacing: 2px;
        }
        .btn-mot:active { background: var(--naranja); color: #000; transform: scale(0.95); }

        /* Inputs: Margen reducido */
        input { 
            background: transparent; border: none; border-bottom: 2px solid #666; 
            color: white; padding: 10px; margin: 10px 0; /* Reducido de 15px */
            width: 100%; max-width: 300px; 
            text-align: center; font-size: 18px; outline: none; transition: 0.3s; border-radius: 0; 
        }
        input:focus { border-bottom-color: var(--naranja); transform: scale(1.05); }

        /* CAPA ROTACIÃ“N */
        #capa-rotar { position: fixed; inset: 0; background: #000; z-index: 100000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        #icono-rotar { font-size: 60px; animation: girar 2s infinite; margin-bottom: 20px; }
        @keyframes girar { 0% { transform: rotate(0deg); } 50% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
        @media (orientation: portrait) { #capa-rotar { display: flex !important; } }

        /* CAPA PAUSA */
        #capa-fullscreen-request {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 99990;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; backdrop-filter: blur(10px);
            padding: 40px;
        }
        
        #btn-toggle-fs {
            position: fixed; top: 20px; left: 20px; z-index: 999999;
            background: rgba(0,0,0,0.3); border: 1px solid #555;
            color: #888; padding: 8px 12px; border-radius: 20px;
            font-size: 11px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
        }
        
        #btn-audio-login {
            position: absolute; top: 20px; right: 20px;
            font-size: 20px; cursor: pointer; opacity: 0.8; z-index: 20;
            background: rgba(0,0,0,0.6); border-radius: 50%; width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center; border: 1px solid #555;
            transition: 0.3s;
        }
        #btn-audio-login:active { transform: scale(0.9); background: var(--naranja); }

        /* Alertas Modal */
        #capa-alerta { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200000; display: none; align-items: center; justify-content: center; }
        .modal-caja { background: #111; border: 2px solid var(--naranja); border-radius: 15px; padding: 30px; max-width: 90%; width: 350px; text-align: center; box-shadow: 0 0 40px rgba(255, 102, 0, 0.3); }
        .modal-titulo { color: var(--naranja); font-size: 20px; font-weight: bold; margin-bottom: 20px; letter-spacing: 2px;}
        .modal-texto { color: #ddd; font-size: 15px; margin-bottom: 20px; line-height: 1.6; }

        /* SELECTOR DE IDIOMA */
        #paso-idioma {
            display: flex; gap: 40px; justify-content: center; margin-top: 15px; /* Reducido */
        }
        .lang-option {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .lang-option:active { transform: scale(1.1); }
        .flag-btn { 
            font-size: 50px; /* Ajustado ligeramente */
            background: none; border: none; cursor: pointer; padding: 0; margin: 0;
        }
        .lang-label {
            margin-top: 10px; font-size: 11px; letter-spacing: 2px; color: #fff; font-weight: bold; opacity: 0.8;
        }

        .oculto { display: none !important; }
    </style>
</head>
<body>

    <div id="capa-alerta">
        <div class="modal-caja">
            <div id="alerta-titulo" class="modal-titulo">AVISO</div>
            <div id="alerta-texto" class="modal-texto">Mensaje...</div>
            <button class="btn-mot" onclick="cerrarAlerta()" style="padding: 12px 25px; margin-top: 0; font-size: 12px; border-color: #555; color: #fff;">ENTENDIDO</button>
        </div>
    </div>

    <div id="btn-toggle-fs" onclick="toggleFullScreen()">â›¶ PANTALLA</div>

    <div id="capa-rotar">
        <div id="icono-rotar">ðŸ“±</div>
        <h3>GIRA TU DISPOSITIVO</h3>
        <p style="opacity: 0.7; font-size: 14px; margin-top: 15px; margin-bottom: 25px; max-width: 80%;">Pon el celular en horizontal para comenzar la aventura.</p>
        <button class="btn-mot" onclick="activarModoInmersivo()">INICIAR AVENTURA</button>
    </div>

    <div id="capa-fullscreen-request" style="display:none;">
        <h2 style="color:var(--naranja); letter-spacing: 5px; margin-bottom: 20px;">PAUSA</h2>
        <p style="margin-bottom: 30px; font-size: 14px; opacity: 0.8; max-width: 80%;">Has salido de la pantalla completa. Toca abajo para volver.</p>
        <button class="btn-mot" onclick="activarModoInmersivo()">CONTINUAR JUEGO</button>
    </div>

    <div id="capa-login" class="capa activa">
        <video id="vid-login" class="video-bg" autoplay loop playsinline src="https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-14.mp4"></video>
        
        <div id="btn-audio-login" onclick="toggleAudioLogin()">ðŸ”Š</div>

        <div class="contenido-central">
            <div style="margin-bottom: 15px;">
                <p style="font-size: 10px; opacity: 0.6; letter-spacing: 4px; margin-bottom: 5px;">BARICHARA</p>
                <h2 style="letter-spacing:3px; color: var(--naranja); font-size: 22px; margin: 0;">BÃšSQUEDA DEL TESORO</h2>
                <p style="font-size: 10px; opacity: 0.6; letter-spacing: 4px; margin-top: 5px;">MOT MOT EXPERIENCIAS</p>
            </div>
            
            <div id="paso-idioma">
                <div class="lang-option" onclick="setLanguage('es')">
                    <button class="flag-btn">ðŸ‡¨ðŸ‡´</button>
                    <span class="lang-label">ESPAÃ‘OL</span>
                </div>
                <div class="lang-option" onclick="setLanguage('en')">
                    <button class="flag-btn">ðŸ‡¬ðŸ‡§</button>
                    <span class="lang-label">ENGLISH</span>
                </div>
            </div>

            <div id="paso-form" style="display:none; width:100%; flex-direction:column; align-items:center;">
                <input type="text" id="reg-nombre" placeholder="Nombre de Explorador" autocomplete="off">
                <input type="text" id="reg-clave" placeholder="CÃ³digo de Acceso" autocomplete="off">
                
                <button id="btn-entrar" class="btn-mot" style="border-color:var(--verde); color:var(--verde);" onclick="iniciarMision()"></button>
                
                <p id="toggle-modo" onclick="alternarModoLogin()" style="margin-top:20px; font-size:12px; text-decoration:underline; cursor:pointer; color:#bbb;">
                    Â¿Ya tienes una misiÃ³n? Reingresar
                </p>

                <button onclick="resetIdioma()" style="background:rgba(255,255,255,0.1); border:1px solid #555; border-radius: 30px; padding: 8px 15px; color:#aaa; margin-top:25px; font-size: 10px; text-transform: uppercase; cursor: pointer; transition:0.3s;">
                    â¬… Cambiar Idioma / Change Language
                </button>
            </div>
        </div>

        <p id="aviso-login" style="margin-top:20px; font-size:13px; color:var(--naranja); font-weight:bold;"></p>
    </div>

    <script>
        const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyH058Ipqtju9KZcLGgzM8TFnjOCSaBGIbEHC-kmzjsft2yV77GbagpuiKecE_i1pkX/exec"; 

        const TEXTOS = {
            es: {
                ph_nombre: "Nombre de Explorador", ph_clave: "Clave de MisiÃ³n", btn_entrar: "INICIAR AVENTURA",
                btn_recuperar: "CONTINUAR MISIÃ“N", toggle_reingreso: "Â¿Ya tienes una misiÃ³n en curso? Reingresar",
                toggle_nuevo: "Â¿Explorador nuevo? Registrarse aquÃ­", 
                err_code: "CÃ“DIGO INVÃLIDO O AGOTADO", err_need_name: "NOMBRE DE EXPLORADOR REQUERIDO",
                msg_recuperando: "VERIFICANDO CREDENCIALES..."
            },
            en: {
                ph_nombre: "Explorer Name", ph_clave: "Mission Key", btn_entrar: "START ADVENTURE",
                btn_recuperar: "RESUME MISSION", toggle_reingreso: "Mission in progress? Resume here",
                toggle_nuevo: "New Explorer? Register here",
                err_code: "INVALID OR EXPIRED CODE", err_need_name: "EXPLORER NAME REQUIRED",
                msg_recuperando: "VERIFYING CREDENTIALS..."
            }
        };

        let idioma = 'es';
        let modoReingreso = false;

        window.onload = () => {
            verificarEstadoPantalla();
            intentarAudioAutomatico(); 

            if(localStorage.getItem('motmot_lang')) {
                idioma = localStorage.getItem('motmot_lang');
            }
            document.addEventListener("fullscreenchange", verificarEstadoPantalla);
            document.addEventListener("webkitfullscreenchange", verificarEstadoPantalla);
            window.addEventListener("resize", verificarEstadoPantalla);
        };

        function intentarAudioAutomatico() {
            const vid = document.getElementById('vid-login');
            const btn = document.getElementById('btn-audio-login');
            
            vid.muted = false;
            let promise = vid.play();
            
            if (promise !== undefined) {
                promise.then(_ => {
                    btn.innerText = "ðŸ”Š";
                }).catch(error => {
                    console.log("Autoplay con sonido bloqueado. Iniciando en Mute.");
                    vid.muted = true;
                    vid.play();
                    btn.innerText = "ðŸ”‡";
                });
            }
        }

        function toggleAudioLogin() {
            const vid = document.getElementById('vid-login');
            const btn = document.getElementById('btn-audio-login');
            
            if (vid.muted) {
                vid.muted = false;
                btn.innerText = "ðŸ”Š"; 
            } else {
                vid.muted = true;
                btn.innerText = "ðŸ”‡"; 
            }
        }

        function activarModoInmersivo() {
            let elem = document.documentElement;
            const vid = document.getElementById('vid-login');
            if(vid.muted) { vid.muted = false; document.getElementById('btn-audio-login').innerText = "ðŸ”Š"; }

            let p;
            if (elem.requestFullscreen) p = elem.requestFullscreen();
            else if (elem.webkitRequestFullscreen) p = elem.webkitRequestFullscreen();
            
            if(p) {
                p.then(() => {
                    document.getElementById('capa-fullscreen-request').style.display = 'none';
                }).catch(err => {
                    document.getElementById('capa-fullscreen-request').style.display = 'none';
                });
            } else {
                document.getElementById('capa-fullscreen-request').style.display = 'none';
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) activarModoInmersivo();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        function verificarEstadoPantalla() {
            const isFullScreen = document.fullscreenElement || document.webkitFullscreenElement;
            const isPortrait = window.innerHeight > window.innerWidth;
            const capaPausa = document.getElementById('capa-fullscreen-request');

            if (!isPortrait && !isFullScreen) {
                capaPausa.style.display = 'flex';
            } else {
                capaPausa.style.display = 'none';
            }
        }

        function mostrarAlerta(texto, titulo="AVISO") {
            document.getElementById('alerta-titulo').innerText = titulo;
            document.getElementById('alerta-texto').innerText = texto;
            document.getElementById('capa-alerta').style.display = 'flex';
        }
        function cerrarAlerta() { document.getElementById('capa-alerta').style.display = 'none'; }

        function setLanguage(lang, anim=true) {
            idioma = lang; localStorage.setItem('motmot_lang', lang);
            const t = TEXTOS[lang];
            
            document.getElementById('reg-nombre').placeholder = t.ph_nombre;
            document.getElementById('reg-clave').placeholder = t.ph_clave;
            document.getElementById('btn-entrar').innerText = modoReingreso ? t.btn_recuperar : t.btn_entrar;
            
            if(anim) {
                document.getElementById('paso-idioma').style.display = 'none';
                document.getElementById('paso-form').style.display = 'flex';
            }
        }

        function resetIdioma() {
            document.getElementById('paso-form').style.display = 'none';
            document.getElementById('paso-idioma').style.display = 'flex';
        }

        function alternarModoLogin() {
            modoReingreso = !modoReingreso;
            const t = TEXTOS[idioma];
            document.getElementById('reg-nombre').className = modoReingreso ? 'oculto' : '';
            document.getElementById('btn-entrar').innerText = modoReingreso ? t.btn_recuperar : t.btn_entrar;
            document.getElementById('toggle-modo').innerText = modoReingreso ? t.toggle_nuevo : t.toggle_reingreso;
        }

        function iniciarMision(esRecarga = false) {
            activarModoInmersivo();

            let nom = document.getElementById('reg-nombre').value.trim();
            const cla = esRecarga ? localStorage.getItem('motmot_clave') : document.getElementById('reg-clave').value.toUpperCase().trim();
            
            if (esRecarga) nom = localStorage.getItem('motmot_agente');
            
            if (!esRecarga && !modoReingreso && !nom) { mostrarAlerta(TEXTOS[idioma].err_need_name); return; }
            if(!cla) return;
            
            if(esRecarga || modoReingreso) document.getElementById('aviso-login').innerText = TEXTOS[idioma].msg_recuperando;

            ejecutarJSONP(`${URL_GOOGLE}?action=registrar_inicio&codigo=${cla}&nombre=${encodeURIComponent(nom)}`, (data) => {
                if(data.status === "success") {
                    localStorage.setItem('motmot_clave', cla);
                    localStorage.setItem('motmot_agente', data.nombre_jugador);
                    localStorage.setItem('motmot_equipo', data.nombre_equipo);
                    localStorage.setItem('motmot_pista', data.pista_actual || 1);
                    
                    if(!esRecarga && data.modo === "reingreso") {
                        mostrarAlerta(`Bienvenido de nuevo Explorador ${data.nombre_jugador}`, "REGRESO");
                    }
                    
                    console.log("Cerebro: Login OK. Esperando mÃ³dulo Tablero...");
                    // irATablero(); 
                } else if(!esRecarga) {
                    if (data.code === "ERR_NEED_NAME") mostrarAlerta(TEXTOS[idioma].err_need_name);
                    else if (data.code === "ERR_USED") mostrarAlerta(TEXTOS[idioma].err_code, "ERROR");
                    else document.getElementById('aviso-login').innerText = TEXTOS[idioma].err_code;
                }
            });
        }

        function ejecutarJSONP(url, callback) {
            const cbName = 'jsonp_' + Math.round(100000 * Math.random());
            window[cbName] = (data) => { delete window[cbName]; document.body.removeChild(script); callback(data); };
            const script = document.createElement('script');
            script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + cbName;
            document.body.appendChild(script);
        }
    </script>
</body>
</html>
