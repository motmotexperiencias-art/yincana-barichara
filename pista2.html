<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>Misi√≥n 2 | Barichara</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        /* --- ESTILOS VISUALES --- */
        body, html { margin: 0; padding: 0; background: #000; color: white; height: 100vh; width: 100vw; font-family: 'Verdana', sans-serif; overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        #app-juego { position: fixed; inset: 0; background: #000; z-index: 10; overflow: hidden; }
        
        /* LAYOUT 50/50 */
        .step { position: absolute; width: 100%; height: 100%; display: none; flex-direction: row; }
        .col-media { flex: 1; height: 100%; position: relative; overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center; }
        .col-text { flex: 1; height: 100%; background: #080808; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; border-left: 2px solid #222; }

        /* M√ìVIL VERTICAL */
        @media screen and (max-width: 768px) and (orientation: portrait) {
            .step { flex-direction: column; }
            .col-text { border-left: none; border-top: 2px solid #222; }
        }

        /* ELEMENTOS DEL GPS */
        #distancia-gps { font-size: clamp(40px, 8vh, 60px); font-weight: bold; color: #ff6600; font-family: monospace; text-shadow: 0 0 20px rgba(255,102,0,0.5); margin: 10px 0; }
        #mapa-interactivo { width: 100%; height: 100%; background: #000; z-index: 1; }
        .leaflet-tile { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); } 

        /* TEXTOS */
        .texto-mision { font-size: clamp(12px, 2vh, 16px); line-height: 1.5; color: #ccc; max-width: 90%; margin-bottom: 20px; }
        .glitch-text { color: #ff6600; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; font-size: 10px; margin-bottom: 10px; }

        /* VIDEO */
        .video-paneo { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }

        /* BOTONES */
        .btn-motmot { background: transparent; border: 2px solid #ff6600; color: #ff6600; padding: 12px 30px; border-radius: 50px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; font-size: 11px; font-weight: bold; transition: 0.3s; margin-top: 10px; }
        .btn-motmot:active { background: #ff6600; color: #000; }

        /* --- CAPAS DE AVISO (EL GUARDI√ÅN DE PANTALLA) --- */
        .capa-aviso { position: fixed; inset: 0; background: #000; z-index: 9000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        
        /* 1. Loader */
        #loader-global { z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,102,0,0.3); border-top: 4px solid #ff6600; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* 2. Aviso Rotaci√≥n (CSS Puro) */
        #aviso-vertical { display: none; z-index: 10000; background: #000; } 
        @media screen and (orientation: portrait) { #aviso-vertical { display: flex !important; } }
        .icon-rotate { font-size: 40px; margin-bottom: 15px; animation: rotatePhone 2s infinite; color: white; }
        @keyframes rotatePhone { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(-90deg); } }

        /* 3. Aviso Pausa (JS) */
        #aviso-pausa { z-index: 9500; background: rgba(0,0,0,0.95); }

        /* SCANNER */
        #scan-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #reader-wrapper { width: 250px; height: 250px; border: 2px solid #ff6600; background: #000; border-radius: 10px; overflow: hidden; position: relative; }
        #reader { width: 100%; height: 100%; }
        .laser { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #ff6600; box-shadow: 0 0 15px #ff6600; animation: scanLaser 2s infinite; z-index: 10; }
        @keyframes scanLaser { 0%, 100% { top: 0; } 50% { top: 100%; } }
        
        #camera-flash { position: fixed; inset: 0; background: white; z-index: 8000; display: none; pointer-events: none; }
    </style>
</head>
<body>

    <div id="loader-global" class="capa-aviso" style="display:flex;">
        <div class="spinner"></div><p style="color:#ff6600; font-size:10px;">CARGANDO...</p>
    </div>
    
    <div id="aviso-vertical" class="capa-aviso">
        <div class="icon-rotate">üì±</div>
        <p style="letter-spacing: 2px; font-weight: bold; color:white;">GIRA EL DISPOSITIVO</p>
    </div>

    <div id="aviso-pausa" class="capa-aviso">
        <h2 style="color:#ff6600; margin-bottom:10px;">JUEGO EN PAUSA</h2>
        <p style="color:#ccc; font-size:12px; margin-bottom:20px;">Toca para continuar en Pantalla Completa</p>
        <button class="btn-motmot" onclick="reanudarJuego()">CONTINUAR</button>
    </div>

    <div id="camera-flash"></div>
    <audio id="snd-tibetano" src="https://www.motmotexperiencias.com/wp-content/uploads/2026/01/tibetan-healing-sounds-cleans-the-aura-and-space-monks-world-367740.mp3" loop></audio>
    <audio id="snd-kids" src="https://www.motmotexperiencias.com/wp-content/uploads/2026/01/kids-game-gaming-background-music-295075.mp3" loop></audio>
    <audio id="snd-exito" src="https://www.motmotexperiencias.com/wp-content/uploads/2025/12/mixkit-game-level-completed-2059.wav"></audio>

    <div id="app-juego">
        
        <div id="step-1" class="step" style="display: flex;">
            <div class="col-media">
                <video id="vid-intro" class="video-paneo" src="https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-7-Compressed-with-FlexClip.mp4" playsinline muted loop autoplay></video>
            </div>
            <div class="col-text">
                <p class="glitch-text" id="lbl-mision">MISI√ìN EN CURSO</p>
                <p class="texto-mision" id="txt-mision-1">"Sigue el rastro de la piedra. El ombligo del saber artesano te espera."</p>
                <button class="btn-motmot" id="btn-rastreo" onclick="activarRastreo()">INICIAR RASTREO</button>
            </div>
        </div>

        <div id="step-gps" class="step">
            <div class="col-media"><div id="mapa-interactivo"></div></div>
            <div class="col-text">
                <p style="color:#444; font-size:9px; letter-spacing:2px;" id="lbl-obj">OBJETIVO: FUNDACI√ìN ESCUELA TALLER</p>
                <div id="distancia-gps">---</div>
                <p id="status-gps" style="color:#ff6600; font-size:8px; letter-spacing:1px;">BUSCANDO SE√ëAL...</p>
                <button id="btn-force" class="btn-motmot" style="display:none; border-color:#333; color:#555; margin-top: 20px;" onclick="llegamos()">OMITIR GPS (DEBUG)</button>
            </div>
        </div>

        <div id="step-narrativa" class="step">
            <div class="col-media">
                <video id="vid-narrativa" class="video-paneo" playsinline muted loop></video>
            </div>
            <div class="col-text">
                <p class="glitch-text" id="lbl-conexion">CONEXI√ìN ESTABLECIDA</p>
                <div id="txt-narrativa" class="texto-mision"></div>
                <button class="btn-motmot" id="btn-cont" onclick="nextNarrativa()">CONTINUAR</button>
            </div>
        </div>

        <div id="step-final" class="step">
            <div class="col-media">
                <video id="vid-bg-final" class="video-paneo" src="https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-16.mp4" playsinline muted loop autoplay></video>
            </div>
            <div class="col-text">
                <p class="glitch-text" id="lbl-localizado">PUNTO LOCALIZADO</p>
                <p class="texto-mision" id="txt-final">Busca el <span style="color:#ff6600;">Pictograma</span> en la entrada y escan√©alo.</p>
                <button class="btn-motmot" id="btn-vision" onclick="abrirEscaner()">üì∏ ACTIVAR VISI√ìN</button>
            </div>
        </div>

    </div>

    <div id="scan-overlay">
        <p style="color:#ff6600; letter-spacing:2px; margin-bottom:20px; font-size:12px; font-weight:bold;">MODO DESCODIFICADOR</p>
        <div id="reader-wrapper">
            <div id="reader"></div>
            <div class="laser"></div>
        </div>
        <button class="btn-motmot" style="margin-top:20px; border-color:#444; color:#666;" onclick="cerrarScanner()">CANCELAR</button>
    </div>

<script>
    // --- CONFIGURACI√ìN ---
    const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbyH058Ipqtju9KZcLGgzM8TFnjOCSaBGIbEHC-kmzjsft2yV77GbagpuiKecE_i1pkX/exec";
    const CODIGO_META = "BARICHARA_PISTA_02"; 
    const DESTINO = { lat: 6.634477, lon: -73.224308 }; 

    // --- IDIOMAS ---
    let idioma = localStorage.getItem('motmot_lang') || 'es';
    const TEXTOS = {
        es: {
            mision_1: `"Sigue el rastro de la piedra. El ombligo del saber artesano te espera."`,
            btn_rastreo: "INICIAR RASTREO",
            status_gps: "BUSCANDO SE√ëAL SATELITAL...",
            obj_gps: "OBJETIVO: FUNDACI√ìN ESCUELA TALLER",
            final: "Busca el <span style='color:#ff6600;'>Pictograma</span> en la entrada y escan√©alo.",
            fragmentos: [
                { txt: "Bienvenidos a la Fundaci√≥n Escuela Taller. Un espacio dedicado a la preservaci√≥n de los saberes ancestrales.", vid: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-15.mp4" },
                { txt: "Bajo estos techos, las manos crean piezas √∫nicas de cer√°mica, tejido guane y mucho m√°s.", vid: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-15.mp4" },
                { txt: "Escucha... La m√∫sica y los oficios mantienen vivo el esp√≠ritu de Santander.", vid: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-16.mp4" }
            ]
        },
        en: {
            mision_1: `"Follow the trail of the stone. The navel of artisan wisdom awaits you."`,
            btn_rastreo: "START TRACKING",
            status_gps: "SEARCHING SATELLITE SIGNAL...",
            obj_gps: "TARGET: WORKSHOP SCHOOL FOUNDATION",
            final: "Find the <span style='color:#ff6600;'>Pictogram</span> at the entrance and scan it.",
            fragmentos: [
                { txt: "Welcome to the Workshop School Foundation. A space dedicated to preserving ancestral knowledge.", vid: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-15.mp4" },
                { txt: "Under these roofs, hands create unique pieces of ceramics, Guane weaving, and much more.", vid: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-15.mp4" },
                { txt: "Listen... Music and crafts keep the spirit of Santander alive.", vid: "https://www.motmotexperiencias.com/wp-content/uploads/2026/01/Diseno-sin-titulo-16.mp4" }
            ]
        }
    };

    let map, userMarker, watchID, qrScanner;
    let idx = 0;

    // --- CARGA INICIAL Y GUARDI√ÅN DE PANTALLA ---
    window.onload = () => {
        aplicarIdioma();
        setTimeout(() => { document.getElementById('loader-global').style.display = 'none'; }, 1000);
        
        // Activar el Guardi√°n
        verificarPantalla();
        window.addEventListener("resize", verificarPantalla);
        document.addEventListener("fullscreenchange", verificarPantalla);
    };

    function verificarPantalla() {
        const isPortrait = window.innerHeight > window.innerWidth;
        const isFullScreen = document.fullscreenElement || document.webkitFullscreenElement;
        const avisoPausa = document.getElementById('aviso-pausa');

        // L√≥gica del Guardi√°n:
        // 1. Si est√° vertical -> CSS lo maneja (#aviso-vertical)
        // 2. Si est√° horizontal PERO no Fullscreen -> Mostrar Pausa
        if (!isPortrait && !isFullScreen) {
            avisoPausa.style.display = 'flex';
        } else {
            avisoPausa.style.display = 'none';
        }
    }

    function reanudarJuego() {
        forzarFullScreen();
        document.getElementById('aviso-pausa').style.display = 'none';
    }

    function forzarFullScreen() {
        let el = document.documentElement;
        if(el.requestFullscreen) el.requestFullscreen().catch(e=>{});
        else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen().catch(e=>{});
    }

    function aplicarIdioma() {
        const t = TEXTOS[idioma];
        document.getElementById('txt-mision-1').innerText = t.mision_1;
        document.getElementById('btn-rastreo').innerText = t.btn_rastreo;
        document.getElementById('status-gps').innerText = t.status_gps;
        document.getElementById('lbl-obj').innerText = t.obj_gps;
        document.getElementById('txt-final').innerHTML = t.final;
    }

    // --- L√ìGICA RASTREO (GPS) ---
    function activarRastreo() {
        forzarFullScreen(); // Intentar FullScreen al iniciar
        document.getElementById('step-1').style.display = 'none';
        document.getElementById('step-gps').style.display = 'flex';
        
        document.getElementById('snd-tibetano').play();
        setTimeout(() => { document.getElementById('btn-force').style.display = 'block'; }, 15000);
        
        map = L.map('mapa-interactivo', { zoomControl: false, attributionControl: false }).setView([DESTINO.lat, DESTINO.lon], 17);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([DESTINO.lat, DESTINO.lon], { icon: L.divIcon({ html: '<div style="background:#ff6600; width:15px; height:15px; border-radius:50%; border:2px solid white; box-shadow: 0 0 15px #ff6600;"></div>', className: '' }) }).addTo(map);

        if (navigator.geolocation) {
            watchID = navigator.geolocation.watchPosition(pos => {
                const { latitude, longitude } = pos.coords;
                const d = calcularDistancia(latitude, longitude, DESTINO.lat, DESTINO.lon);
                document.getElementById('distancia-gps').innerText = Math.round(d) + "m";
                
                if (!userMarker) {
                    userMarker = L.marker([latitude, longitude], { icon: L.divIcon({ html: '<div style="width:14px; height:14px; background:#fff; border:3px solid #ff6600; border-radius:50%; box-shadow:0 0 15px #ff6600;"></div>', className: '' }) }).addTo(map);
                } else { userMarker.setLatLng([latitude, longitude]); }
                map.fitBounds(L.latLngBounds([latitude, longitude], [DESTINO.lat, DESTINO.lon]), {padding: [50, 50]});
                
                if (d < 25) llegamos();
            }, null, { enableHighAccuracy: true });
        }
    }

    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // --- TRANSICI√ìN A NARRATIVA ---
    function llegamos() {
        if(watchID) navigator.geolocation.clearWatch(watchID);
        let tibetano = document.getElementById('snd-tibetano');
        let fadeOut = setInterval(() => {
            if(tibetano.volume > 0.1) tibetano.volume -= 0.1;
            else { clearInterval(fadeOut); tibetano.pause(); }
        }, 100);

        let kids = document.getElementById('snd-kids');
        kids.volume = 0.6;
        kids.play();

        document.getElementById('step-gps').style.display = 'none';
        document.getElementById('step-narrativa').style.display = 'flex';
        actualizarNarrativa();
    }

    function actualizarNarrativa() {
        const data = TEXTOS[idioma].fragmentos[idx];
        const vid = document.getElementById('vid-narrativa');
        const txt = document.getElementById('txt-narrativa');
        txt.style.opacity = 0;
        setTimeout(() => { txt.innerText = data.txt; txt.style.opacity = 1; }, 200);

        if (!vid.src.includes(data.vid)) {
            vid.style.opacity = 0;
            setTimeout(() => { vid.src = data.vid; vid.play(); vid.style.opacity = 0.8; }, 500);
        }
    }

    function nextNarrativa() {
        idx++;
        if(idx < TEXTOS[idioma].fragmentos.length) {
            actualizarNarrativa();
        } else {
            document.getElementById('step-narrativa').style.display = 'none';
            document.getElementById('step-final').style.display = 'flex';
            document.getElementById('vid-bg-final').play();
        }
    }

    // --- SCANNER FINAL ---
    function abrirEscaner() {
        const overlay = document.getElementById('scan-overlay');
        overlay.style.display = 'flex';
        if (qrScanner) qrScanner.clear();
        qrScanner = new Html5Qrcode("reader");
        qrScanner.start(
            { facingMode: "environment" }, 
            { fps: 15, qrbox: { width: 250, height: 250 } }, 
            (decodedText) => {
                if(decodedText.includes(CODIGO_META)) {
                    ejecutarEfectoExito();
                    qrScanner.stop();
                }
            }
        ).catch(err => { alert("Error c√°mara: " + err); overlay.style.display = 'none'; });
    }

    function cerrarScanner() {
        if(qrScanner) qrScanner.stop();
        document.getElementById('scan-overlay').style.display = 'none';
    }

    // --- GUARDADO Y SALIDA ---
    function ejecutarEfectoExito() {
        document.getElementById('camera-flash').style.display = 'block';
        document.getElementById('snd-exito').play();
        document.getElementById('snd-kids').pause();

        localStorage.setItem('motmot_pista', 3); 

        const usuario = localStorage.getItem('motmot_clave');
        if(usuario) {
            const urlFinal = `${URL_GOOGLE}?action=guardar_progreso&codigo=${usuario}&pista=3`;
            ejecutarJSONP(urlFinal, (data) => {
                setTimeout(() => { window.location.href = "index.html"; }, 2000);
            });
        } else {
            setTimeout(() => { window.location.href = "index.html"; }, 2000);
        }
    }

    function ejecutarJSONP(url, callback) {
        const cbName = 'jsonp_' + Math.round(100000 * Math.random());
        window[cbName] = (data) => { delete window[cbName]; document.body.removeChild(script); callback(data); };
        const script = document.createElement('script');
        script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + cbName;
        document.body.appendChild(script);
    }
</script>
</body>
</html>
